<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=">


  <link rel="mask-icon" href="/images/logo.svg?v=" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="黄国航的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="黄国航的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="黄国航的博客">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>黄国航的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黄国航的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/" itemprop="url">Shiro jwt 构建无状态分布式鉴权体系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T19:57:22+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/" class="cy_cmt_count" data-xid="2019/06/07/shiro jwt 构建无状态分布式鉴权体系/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##概括</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/JWI%20Token%E7%AD%BE%E5%8F%91%E5%92%8C%E9%89%B4%E6%9D%83.png" alt="JWT鉴权场景"></p>
<p>在分布式系统中，没法将认证、授权信息保存在session或本地内存中，这里使用JWT Token的方式来保存认证信息。需要提供一个令牌签发服务来进行Tokean的签发，每次请求的时候带上该Token，每个被调用的服务都需要有对该Token进行鉴权的功能。</p>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p>JWT(json web token)是可在网络上传输的用于声明某种主张的令牌（token），以JSON 对象为载体的轻量级开放标准（RFC 7519）。</p>
<p>一个JWT令牌的定义包含头信息、荷载信息、签名信息三个部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Header//头信息</span><br><span class="line">&#123;</span><br><span class="line">    &quot;alg&quot;: &quot;HS256&quot;,//签名或摘要算法</span><br><span class="line">    &quot;typ&quot;: &quot;JWT&quot;//token类型</span><br><span class="line">&#125;</span><br><span class="line">Playload//荷载信息</span><br><span class="line">&#123;</span><br><span class="line">    &quot;iss&quot;: &quot;token-server&quot;,//签发者</span><br><span class="line">    &quot;exp &quot;: &quot;Mon Nov 13 15:28:41 CST 2017&quot;,//过期时间</span><br><span class="line">    &quot;sub &quot;: &quot;wangjie&quot;,//用户名</span><br><span class="line">    &quot;aud&quot;: &quot;web-server-1&quot;//接收方,</span><br><span class="line">    &quot;nbf&quot;: &quot;Mon Nov 13 15:40:12 CST 2017&quot;,//这个时间之前token不可用</span><br><span class="line">    &quot;jat&quot;: &quot;Mon Nov 13 15:20:41 CST 2017&quot;,//签发时间</span><br><span class="line">    &quot;jti&quot;: &quot;0023&quot;,//令牌id标识</span><br><span class="line">    &quot;claim&quot;: &#123;“auth”:”ROLE_ADMIN”&#125;//访问主张</span><br><span class="line">&#125;</span><br><span class="line">Signature//签名信息</span><br><span class="line">签名或摘要算法（</span><br><span class="line">    base64urlencode（Header），</span><br><span class="line">    Base64urlencode（Playload），</span><br><span class="line">    secret-key</span><br><span class="line">）</span><br></pre></td></tr></table></figure>
<p>按照JWT规范，对这个令牌定义进行如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">base64urlencode（Header）</span><br><span class="line">+&quot;.&quot;+</span><br><span class="line">base64urlencode（Playload）</span><br><span class="line">+&quot;.&quot;+</span><br><span class="line">signature（</span><br><span class="line">    base64urlencode（Header）</span><br><span class="line">    +&quot;.&quot;+</span><br><span class="line">    base64urlencode（Playload）</span><br><span class="line">    ,secret-key</span><br><span class="line">）</span><br></pre></td></tr></table></figure>
<p>形成一个完整的JWT:<br><code>eyJhbGciOiJIUzUxMiIsInppcCI6IkRFRiJ9.eNqqVspMLFGyMjQ1NDA1tTA0NNRRKi5NUrJSKk_MS8_KTFXSUUqtKEAoMDKsBQAAAP__.dGLe7BVECKzQ_utZJqk4hbcBZthNhohuEjjue98vmpQSGn_9cCYHq7lPIfwKubW8M553F8Uhk933EJwgI5vbLQ</code></p>
<p>需要注意的是：</p>
<p>1：荷载信息(Playload)中的属性可以根据情况进行设置，不要求必须全部填写。</p>
<p>2：由token的生成方式发现，Header和Playload仅仅是base64编码，通过base64解码之后可见，基本相当于是明文传输，所以应避免敏感信息放入Playload。</p>
<p><strong>2、令牌特点</strong></p>
<p>紧凑性：体积较小、意味着传输速度快，可以作为POST参数或放置在HTTP头。</p>
<p>自包含性：有效的负载包含用户鉴权所需所有信息，避免多次查询数据库。</p>
<p>安全性：支持对称和非对称方式(HMAC、RSA)进行消息摘要签名。</p>
<p>标准化：开放标准，多语言支持，跨平台。</p>
<p><strong>3、适用场景</strong></p>
<p>1：无状态、分布式鉴权，比如rest api系统、微服务系统。</p>
<p>2：方便解决跨域授权的问题，比如SSO单点登陆。</p>
<p>3：JWT只是消息协议，不牵涉到会话管理和存储机制，所以单体WEB应用还是推荐session-cookie机制。</p>
<h3 id="典型微服务鉴权架构"><a href="#典型微服务鉴权架构" class="headerlink" title="典型微服务鉴权架构"></a>典型微服务鉴权架构</h3><p>客户端（移动端或者pc端）根据口令或者APP KEY到认证服务鉴权并申请签发令牌，如果需要操作服务A，必须先拿着令牌到服务A进行权限问询。如果需要操作服务B，同样先拿着令牌到服务B进行权限问询，一个令牌可以一次，也可以多次使用连续穿梭多个服务系统，直至令牌过期失效或被销毁。</p>
<p>JWT令牌使用了数字签名可以有效的防止数据篡改和窃取，同样申请令牌时的数据也需要有这样的安全保障，可以使用HMAC(哈希运算消息认证码)进行签名（摘要）和验签（参考：<a href="https://www.jianshu.com/p/b0a577708a7b" target="_blank" rel="noopener">基于hmac的rest api鉴权处理</a>）。</p>
<p>shiro是java业界普遍采用的安全框架，简单、够用、扩展性强。我们可以在shiro中添加对HMAC和JWT这两种鉴权方式的支持。</p>
<h2 id="令牌签发服务"><a href="#令牌签发服务" class="headerlink" title="令牌签发服务"></a>令牌签发服务</h2><p>签发服务的核心功能是验证客户端是否合法，如果合法则授予其包含特定访问主张的JWT。</p>
<p>shiro Token定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * HMAC令牌</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacToken implements AuthenticationToken&#123;</span><br><span class="line">    private static final long serialVersionUID = -7838912794581842158L;</span><br><span class="line">    </span><br><span class="line">    private String clientKey;// 客户标识（可以是用户名、app id等等）</span><br><span class="line">    private String digest;// 消息摘要</span><br><span class="line">    private String timeStamp;// 时间戳</span><br><span class="line">    private Map&lt;String, String[]&gt; parameters;// 访问参数</span><br><span class="line">    private String host;// 客户端IP</span><br><span class="line">    </span><br><span class="line">    public HmacToken(String clientKey,String timeStamp,String digest</span><br><span class="line">                                ,String host,Map&lt;String, String[]&gt; parameters)&#123;</span><br><span class="line">        this.clientKey = clientKey;</span><br><span class="line">        this.timeStamp = timeStamp;</span><br><span class="line">        this.digest = digest;</span><br><span class="line">        this.host = host;</span><br><span class="line">        this.parameters = parameters;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Object getPrincipal() &#123;</span><br><span class="line">        return this.clientKey;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Object getCredentials() &#123;</span><br><span class="line">        return Boolean.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 省略getters and setters ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>shiro Realm即验证逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于HMAC（ 散列消息认证码）的控制域</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacRealm extends AuthorizingRealm&#123;</span><br><span class="line">    </span><br><span class="line">    private final AccountProvider accountProvider;//账号服务(持久化服务)</span><br><span class="line">    private final CryptogramService cryptogramService;//密码服务</span><br><span class="line"></span><br><span class="line">    public HmacRealm(AccountProvider accountProvider,CryptogramService cryptogramService)&#123;</span><br><span class="line">        this.accountProvider = accountProvider;</span><br><span class="line">        this.cryptogramService = cryptogramService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Class&lt;?&gt; getAuthenticationTokenClass() &#123;</span><br><span class="line">        return HmacToken.class;//此Realm只支持HmacToken</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     *  认证</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) </span><br><span class="line">                                                          throws AuthenticationException &#123;</span><br><span class="line">        HmacToken hmacToken = (HmacToken)token;</span><br><span class="line">        List&lt;String&gt; keys = Lists.newArrayList();</span><br><span class="line">        for (String key:hmacToken.getParameters().keySet())&#123;</span><br><span class="line">            if (!&quot;digest&quot;.equals(key))</span><br><span class="line">                keys.add(key);</span><br><span class="line">        &#125;</span><br><span class="line">        Collections.sort(keys);//对请求参数进行排序参数-&gt;自然顺序</span><br><span class="line">        StringBuffer baseString = new StringBuffer();</span><br><span class="line">        for (String key : keys) &#123;</span><br><span class="line">            baseString.append(hmacToken.getParameters().get(key)[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        //认证端生成摘要</span><br><span class="line">        String serverDigest = cryptogramService.hmacDigest(baseString.toString());</span><br><span class="line">        //客户端请求的摘要和服务端生成的摘要不同</span><br><span class="line">        if(!serverDigest.equals(hmacToken.getDigest()))&#123;</span><br><span class="line">            throw new AuthenticationException(&quot;数字摘要验证失败！！！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Long visitTimeStamp = Long.valueOf(hmacToken.getTimeStamp());</span><br><span class="line">        Long nowTimeStamp = System.currentTimeMillis();</span><br><span class="line">        Long jge = nowTimeStamp - visitTimeStamp;</span><br><span class="line">        if (jge &gt; 600000) &#123;// 十分钟之前的时间戳，这是有效期可以双方约定由参数传过来</span><br><span class="line">            throw new AuthenticationException(&quot;数字摘要失效！！！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // 此处可以添加查询数据库检查账号是否存在、是否被锁定、是否被禁用等等逻辑</span><br><span class="line">        return new SimpleAuthenticationInfo(hmacToken.getClientKey(),Boolean.TRUE,getName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /** </span><br><span class="line">     * 授权 </span><br><span class="line">     */  </span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        String clientKey = (String)principals.getPrimaryPrincipal();</span><br><span class="line">        SimpleAuthorizationInfo info =  new SimpleAuthorizationInfo();</span><br><span class="line">        // 根据客户标识（可以是用户名、app id等等） 查询并设置角色</span><br><span class="line">        Set&lt;String&gt; roles = accountProvider.loadRoles(clientKey);</span><br><span class="line">        info.setRoles(roles);</span><br><span class="line">      // 根据客户标识（可以是用户名、app id等等） 查询并设置权限</span><br><span class="line">        Set&lt;String&gt; permissions = accountProvider.loadPermissions(clientKey);</span><br><span class="line">        info.setStringPermissions(permissions);</span><br><span class="line">        return info;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HMAC认证过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于HMAC（ 散列消息认证码）的无状态认证过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacFilter extends AccessControlFilter&#123;</span><br><span class="line">    </span><br><span class="line">    private static final Logger log = LoggerFactory.getLogger(AccessControlFilter.class);</span><br><span class="line">    </span><br><span class="line">    public static final String DEFAULT_CLIENTKEY_PARAM = &quot;clientKey&quot;;</span><br><span class="line">    public static final String DEFAULT_TIMESTAMP_PARAM = &quot;timeStamp&quot;;</span><br><span class="line">    public static final String DEFAUL_DIGEST_PARAM = &quot;digest&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否放行</span><br><span class="line">     */</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, </span><br><span class="line">                                                        Object mappedValue) throws Exception &#123;</span><br><span class="line">        if (null != getSubject(request, response) </span><br><span class="line">                &amp;&amp; getSubject(request, response).isAuthenticated()) &#123;</span><br><span class="line">            return true;//已经认证过直接放行</span><br><span class="line">        &#125;</span><br><span class="line">        return false;//转到拒绝访问处理逻辑</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 拒绝处理</span><br><span class="line">     */</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response)  </span><br><span class="line">                                                                          throws Exception &#123;</span><br><span class="line">        if(isHmacSubmission(request))&#123;//如果是Hmac鉴权的请求</span><br><span class="line">            //创建令牌</span><br><span class="line">            AuthenticationToken token = createToken(request, response);</span><br><span class="line">            try &#123;</span><br><span class="line">                Subject subject = getSubject(request, response);</span><br><span class="line">                subject.login(token);//认证</span><br><span class="line">                return true;//认证成功，过滤器链继续</span><br><span class="line">            &#125; catch (AuthenticationException e) &#123;//认证失败，发送401状态并附带异常信息</span><br><span class="line">                log.error(e.getMessage(),e);</span><br><span class="line">                WebUtils.toHttp(response).sendError(HttpServletResponse.SC_UNAUTHORIZED,e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;//打住，访问到此为止</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AuthenticationToken createToken(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        String clientKey = request.getParameter(DEFAULT_CLIENTKEY_PARAM);</span><br><span class="line">        String timeStamp= request.getParameter(DEFAULT_TIMESTAMP_PARAM);</span><br><span class="line">        String digest= request.getParameter(DEFAUL_DIGEST_PARAM);</span><br><span class="line">        Map&lt;String, String[]&gt; parameters = request.getParameterMap();</span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        return new HmacToken(clientKey, timeStamp, digest, host,parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected boolean isHmacSubmission(ServletRequest request) &#123;</span><br><span class="line">        String clientKey = request.getParameter(DEFAULT_CLIENTKEY_PARAM);</span><br><span class="line">        String timeStamp= request.getParameter(DEFAULT_TIMESTAMP_PARAM);</span><br><span class="line">        String digest= request.getParameter(DEFAUL_DIGEST_PARAM);</span><br><span class="line">        return (request instanceof HttpServletRequest)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(clientKey)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(timeStamp)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(digest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HMAC鉴权最基础的工作就此完成，需要注意的是鉴权是无状态的不需要创建SESSION,所以需要对shiro的SubjectFactory做一下改造，并设置到SecurityManager ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 扩展自DefaultWebSubjectFactory,对于无状态的TOKEN 类型不创建session</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604)</span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class AgileSubjectFactory extends DefaultWebSubjectFactory &#123; </span><br><span class="line"></span><br><span class="line">    public Subject createSubject(SubjectContext context) &#123; </span><br><span class="line">        AuthenticationToken token = context.getAuthenticationToken();</span><br><span class="line">        if((token instanceof HmacToken))&#123;</span><br><span class="line">            // 当token为HmacToken时， 不创建 session </span><br><span class="line">            context.setSessionCreationEnabled(false);</span><br><span class="line">        &#125;</span><br><span class="line">        return super.createSubject(context); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT签发逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/auth&quot;)</span><br><span class="line">public class AuthenticateAction &#123;</span><br><span class="line">    private final String SECRET_KEY = &quot;*(-=4eklfasdfarerf41585fdasf&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value=&quot;/apply-token&quot;,method=RequestMethod.POST)</span><br><span class="line">    public Map&lt;String,Object&gt; applyToken(@RequestParam(name=&quot;clientKey&quot;) String clientKey) &#123;</span><br><span class="line">        // 签发一个Json Web Token</span><br><span class="line">        // 令牌ID=uuid，用户=clientKey，签发者=clientKey</span><br><span class="line">        // token有效期=1分钟，用户角色=null,用户权限=create,read,update,delete</span><br><span class="line">        String jwt = issueJwt(UUID.randomUUID().toString(), clientKey, </span><br><span class="line">                                    &quot;token-server&quot;,60000l, null, &quot;create,read,update,delete&quot;);</span><br><span class="line">        Map&lt;String,Object&gt; respond = Maps.newHashMap();</span><br><span class="line">        respond.put(&quot;jwt&quot;, jwt);</span><br><span class="line">        return respond;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * @param id 令牌ID</span><br><span class="line">     * @param subject 用户ID</span><br><span class="line">     * @param issuer 签发人</span><br><span class="line">     * @param period 有效时间(毫秒)</span><br><span class="line">     * @param roles 访问主张-角色</span><br><span class="line">     * @param permissions 访问主张-权限</span><br><span class="line">     * @param algorithm 加密算法</span><br><span class="line">     * @return json web token </span><br><span class="line">     */</span><br><span class="line">    private String issueJwt(String id,String subject,String issuer,Long period,String roles</span><br><span class="line">                                            ,String permissions,SignatureAlgorithm algorithm) &#123;</span><br><span class="line">        long currentTimeMillis = System.currentTimeMillis();// 当前时间戳</span><br><span class="line">        byte[] secretKeyBytes = DatatypeConverter.parseBase64Binary(SECRET_KEY);// 秘钥</span><br><span class="line">        JwtBuilder jwt  =  Jwts.builder();</span><br><span class="line">        if(Strings.isNotBlank(id)) jwt.setId(id);</span><br><span class="line">        jwt.setSubject(subject);// 用户名主题</span><br><span class="line">        if(Strings.isNotBlank(issuer)) jwt.setIssuer(issuer);//签发者</span><br><span class="line">        if(Strings.isNotBlank(issuer)) jwt.setIssuer(issuer);//签发者  </span><br><span class="line">        jwt.setIssuedAt(new Date(currentTimeMillis));//签发时间</span><br><span class="line">        if(null != period)&#123;</span><br><span class="line">            Date expiration = new Date(currentTimeMillis+period);</span><br><span class="line">            jwt.setExpiration(expiration);//有效时间</span><br><span class="line">        &#125;</span><br><span class="line">        if(Strings.isNotBlank(roles)) jwt.claim(&quot;roles&quot;, roles);//角色</span><br><span class="line">        if(Strings.isNotBlank(permissions)) jwt.claim(&quot;perms&quot;, permissions);//权限</span><br><span class="line">        jwt.compressWith(CompressionCodecs.DEFLATE);//压缩，可选GZIP</span><br><span class="line">        jwt.signWith(algorithm, secretKeyBytes);//加密设置</span><br><span class="line">        return jwt.compact();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加过滤器：filterChainManager.addFilter( “hmac”, new HmacFilter()）;<br>配置过滤规则：filterChainManager.addToChain(“/auth/**”, “hmac”);<br>如果有需要可以在规则中添加其他过滤器。<br>JWT申请测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public String applyToken()&#123;</span><br><span class="line">    Long current = System.currentTimeMillis() ;</span><br><span class="line">    String url = &quot;http://localhost:8080/tokenServer/auth/apply-token&quot;;</span><br><span class="line">    MultiValueMap&lt;String, Object&gt; dataMap = new LinkedMultiValueMap&lt;String, Object&gt;();  </span><br><span class="line">    String clientKey = &quot;administrator&quot;;// 客户端标识（用户名）</span><br><span class="line">    String mix = String.valueOf(new Random().nextFloat());// 随机数，进行混淆</span><br><span class="line">    String timeStamp = current.toString();// 时间戳</span><br><span class="line">    dataMap.add(&quot;clientKey&quot;, clientKey);</span><br><span class="line">    dataMap.add(&quot;mix&quot;, mix);</span><br><span class="line">    dataMap.add(&quot;timeStamp&quot;, timeStamp);</span><br><span class="line">    String baseString = clientKey+mix+timeStamp;</span><br><span class="line">    String digest =  hmacDigest(baseString);// 生成HMAC摘要</span><br><span class="line">    dataMap.add(&quot;digest&quot;, digest);</span><br><span class="line">    Map result = rt.postForObject(url, dataMap, Map.class);</span><br><span class="line">    return (String)result.get(&quot;jwt&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回JWT：</p>
<blockquote>
<p>eyJhbGciOiJIUzUxMiIsInppcCI6IkRFRiJ9.eNo8y80KwjAQBOB32XMCTfNj7NvsNluI2jYkWxHEdzf14GUYPmbecJMMEwzXGAjnUdvBR-2cdzpSRE2jiUtwSLQEUNAO6mNMa95yk4qy1665ta6y33nTjeuTf4gCk_HGWBvtxSjgV_mDsx0K1_U8zpVRWPVM6ijp7IkfLAyfLwAAAP__.GK7EJibs7n50uGksvvLK6Y39Ur6ZYXoXI9LOlFwEpIijHGAZjIyDhiYD-1nv1YbPJ46BI-gDTntV3KC0d8NSrA</p>
</blockquote>
<h2 id="令牌验签"><a href="#令牌验签" class="headerlink" title="令牌验签"></a>令牌验签</h2><p>有了JWT签发服务，要使用JWT就需要业务系统有JWT验鉴功能，同样在shiro中集成。<br>由于JWT是自包含的，令牌中已经声明了访问主张(比如角色、权限等)，验签功能只需要验证令牌合法就行了，不需要访问数据库。</p>
<p>shiro Token定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * JWT令牌</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtToken implements AuthenticationToken&#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -790191688300000066L;</span><br><span class="line">    </span><br><span class="line">    private String jwt;// json web token</span><br><span class="line">    private String host;// 客户端IP</span><br><span class="line">    </span><br><span class="line">    public JwtToken(String jwt,String host)&#123;</span><br><span class="line">        this.jwt = jwt;</span><br><span class="line">        this.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getPrincipal() &#123;</span><br><span class="line">        return this.jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getCredentials() &#123;</span><br><span class="line">        return Boolean.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 忽略getters and setters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT Realm即认证逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT（ JSON WEB TOKEN）的认证域</span><br><span class="line"> * </span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604)</span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtRealm extends AuthorizingRealm &#123;</span><br><span class="line"></span><br><span class="line">    public Class&lt;?&gt; getAuthenticationTokenClass() &#123;</span><br><span class="line">        return JwtToken.class;//此Realm只支持JwtToken</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 认证</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) </span><br><span class="line">                                                        throws AuthenticationException &#123;</span><br><span class="line">        JwtToken jwtToken = (JwtToken) token;</span><br><span class="line">        String jwt = (String) jwtToken.getPrincipal();</span><br><span class="line">        JwtPlayload jwtPlayload;</span><br><span class="line">        try &#123;</span><br><span class="line">            Claims claims = Jwts.parser()</span><br><span class="line">                    .setSigningKey(DatatypeConverter.parseBase64Binary(SECRETKEY))</span><br><span class="line">                    .parseClaimsJws(jwt)</span><br><span class="line">                    .getBody();</span><br><span class="line">            jwtPlayload = new JwtPlayload();</span><br><span class="line">            jwtPlayload.setId(claims.getId());</span><br><span class="line">            jwtPlayload.setUserId(claims.getSubject());// 用户名</span><br><span class="line">            jwtPlayload.setIssuer(claims.getIssuer());// 签发者</span><br><span class="line">            jwtPlayload.setIssuedAt(claims.getIssuedAt());// 签发时间</span><br><span class="line">            jwtPlayload.setAudience(claims.getAudience());// 接收方</span><br><span class="line">            jwtPlayload.setRoles(claims.get(&quot;roles&quot;, String.class));// 访问主张-角色</span><br><span class="line">            jwtPlayload.setPerms(claims.get(&quot;perms&quot;, String.class));// 访问主张-权限</span><br><span class="line">        &#125; catch (ExpiredJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌过期:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (UnsupportedJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌无效:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (MalformedJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌格式错误:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (SignatureException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌签名无效:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌参数异常:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌错误:&quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        // 如果要使token只能使用一次，此处可以过滤并缓存jwtPlayload.getId()</span><br><span class="line">        // 可以做签发方验证</span><br><span class="line">        // 可以做接收方验证</span><br><span class="line">        return new SimpleAuthenticationInfo(jwtPlayload, Boolean.TRUE, getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权,JWT已包含访问主张只需要解析其中的主张定义就行了</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        JwtPlayload jwtPlayload = (JwtPlayload) principals.getPrimaryPrincipal();</span><br><span class="line">        SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();</span><br><span class="line">        // 解析角色并设置</span><br><span class="line">        Set&lt;String&gt; roles = Sets.newHashSet(StringUtils.split(jwtPlayload.getRoles(), &quot;,&quot;));</span><br><span class="line">        info.setRoles(roles);</span><br><span class="line">        // 解析权限并设置</span><br><span class="line">        Set&lt;String&gt; permissions = Sets.newHashSet(StringUtils.split(jwtPlayload.getPerms(), &quot;,&quot;));</span><br><span class="line">        info.setStringPermissions(permissions);</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理逻辑中抛出的异常信息很详细，其实这样并不安全只是对调试友好，线上环境不用把异常信息给那么细。</p>
<p>JWT鉴权过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT标准的无状态认证过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> * </span><br><span class="line"> */ </span><br><span class="line">public class JwtFilter extends AccessControlFilter &#123;</span><br><span class="line">    </span><br><span class="line">    private static final Logger log = LoggerFactory.getLogger(AccessControlFilter.class);</span><br><span class="line">    </span><br><span class="line">    public static final String DEFAULT_JWT_PARAM = &quot;jwt&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception &#123;</span><br><span class="line">        if (null != getSubject(request, response) </span><br><span class="line">                &amp;&amp; getSubject(request, response).isAuthenticated()) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws Exception &#123;</span><br><span class="line">        if(isJwtSubmission(request))&#123;</span><br><span class="line">            AuthenticationToken token = createToken(request, response);</span><br><span class="line">            try &#123;</span><br><span class="line">                Subject subject = getSubject(request, response);</span><br><span class="line">                subject.login(token);</span><br><span class="line">                return true;</span><br><span class="line">            &#125; catch (AuthenticationException e) &#123;</span><br><span class="line">                log.error(e.getMessage(),e);</span><br><span class="line">                WebUtils.toHttp(response).sendError(HttpServletResponse.SC_UNAUTHORIZED,e.getMessage());</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AuthenticationToken createToken(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        String jwt = request.getParameter(DEFAULT_JWT_PARAM);</span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        log.info(&quot;authenticate jwt token:&quot;+jwt);</span><br><span class="line">        System.out.println(&quot;jwt:&quot;+jwt);</span><br><span class="line">        return new JwtToken(jwt, host);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected boolean isJwtSubmission(ServletRequest request) &#123;</span><br><span class="line">        String jwt = request.getParameter(DEFAULT_JWT_PARAM);</span><br><span class="line">        return (request instanceof HttpServletRequest)</span><br><span class="line">                                &amp;&amp; StringUtils.isNotBlank(jwt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>资源访问权限过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT（ JSON WEB TOKEN）的无状态资源过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtPermFilter extends HmacFilter&#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, </span><br><span class="line">                                                    Object mappedValue) throws Exception &#123;</span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        String[] perms = (String[]) mappedValue;</span><br><span class="line">        boolean isPermitted = true;</span><br><span class="line">        if (perms != null &amp;&amp; perms.length &gt; 0) &#123;</span><br><span class="line">            if (perms.length == 1) &#123;</span><br><span class="line">                if (!subject.isPermitted(perms[0])) &#123;</span><br><span class="line">                    isPermitted = false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (!subject.isPermittedAll(perms)) &#123;</span><br><span class="line">                    isPermitted = false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return isPermitted;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加过滤器：filterChainManager.addFilter( “jwt”, new JwtFilter()）;<br>filterChainManager.addFilter( “jwtPerms”, new JwtPermFilter()）;<br>配置过滤规则：filterChainManager.addToChain(“/api/<strong>“, “jwt”);filterChainManager.addToChain(“/api/delete/</strong>“, “jwtPerms[“api:delete”]”);<br>如果有需要可以在规则中添加其他过滤器。<br>同令牌申请服务一样，需要设置shiro不创建SESSION。</p>
<p>转自：<a href="https://wangjie2016.iteye.com/blog/2406870" target="_blank" rel="noopener">shiro jwt 构建无状态分布式鉴权体系</a></p>
<h2 id="项目推荐：功能强大的jsets-shiro-spring-boot-starter"><a href="#项目推荐：功能强大的jsets-shiro-spring-boot-starter" class="headerlink" title="项目推荐：功能强大的jsets-shiro-spring-boot-starter"></a>项目推荐：功能强大的jsets-shiro-spring-boot-starter</h2><p>github地址：<a href="https://github.com/wj596/jsets-shiro-spring-boot-starter" target="_blank" rel="noopener">jsets-shiro-spring-boot-starter</a></p>
<p><strong>项目说明：</strong></p>
<p>springboot中使用shiro大都是通过shiro-spring.jar进行的整合的,虽然不是太复杂，但是也无法做到spring-boot-starter风格的开箱即用。</p>
<p>项目中经常用到的功能比如：验证码、密码错误次数限制、账号唯一用户登陆、动态URL过滤规则、无状态鉴权等等，shiro还没有直接提供支持。</p>
<p>jsets-shiro-spring-boot-starter对这些常用的功能进行了封装和自动导入，少量的配置就可以应用在项目中。</p>
<p><strong>推荐理由：</strong></p>
<ul>
<li><p>springboot-start开箱即用</p>
</li>
<li><p>提供动态URL过滤规则的功能，让你可以从数据库中读取权限信息，修改的权限之后还可动态刷新url过滤规则</p>
</li>
<li>提供无状态鉴权功能</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/07/Springboot整合Shiro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/Springboot整合Shiro/" itemprop="url">Springboot整合Shiro</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T19:57:22+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2019/06/07/Springboot整合Shiro/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2019/06/07/Springboot整合Shiro/" class="cy_cmt_count" data-xid="2019/06/07/Springboot整合Shiro/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>视频地址：<a href="https://www.bilibili.com/video/av40342174?from=search&amp;seid=5659043412897097160" target="_blank" rel="noopener">SpringBoot与Shiro整合-权限管理实战视频</a></p>
<h1 id="1-课程内容简介"><a href="#1-课程内容简介" class="headerlink" title="1.   课程内容简介"></a>1.   课程内容简介</h1><h2 id="1-1-内容简介"><a href="#1-1-内容简介" class="headerlink" title="1.1. 内容简介"></a>1.1. 内容简介</h2><p>本课程主要讲解如何使用Spring Boot与Shiro进行整合使用，实现强大的用户权限管理，其中涉及如何完成用户认证（即用户登录），用户授权，thymeleaf页面整合shiro权限标签等知识点。</p>
<h2 id="1-2-课程目标"><a href="#1-2-课程目标" class="headerlink" title="1.2. 课程目标"></a>1.2. 课程目标</h2><p>快速掌握SpringBoot与Shiro安全框架的整合使用</p>
<h2 id="1-3-课程相关软件"><a href="#1-3-课程相关软件" class="headerlink" title="1.3. 课程相关软件"></a>1.3. 课程相关软件</h2><p>Eclipse Mar2</p>
<p>Spring Boot 1.5.4.RELEASE</p>
<p>Shiro1.4.0</p>
<h1 id="2-Spring-Boot与Shiro框架简介"><a href="#2-Spring-Boot与Shiro框架简介" class="headerlink" title="2.   Spring Boot与Shiro框架简介"></a>2.   Spring Boot与Shiro框架简介</h1><h2 id="2-1-Spring-Boot框架简介"><a href="#2-1-Spring-Boot框架简介" class="headerlink" title="2.1. Spring Boot框架简介"></a>2.1. Spring Boot框架简介</h2><p>Spring的诞生是 Java 企业版（Java Enterprise Edition，JEE，也称 J2EE）的</p>
<p>轻量级代替品。无需开发重量级的 Enterprise JavaBean（EJB），Spring 为企业级</p>
<p>Java 开发提供了一种相对简单的方法，通过依赖注入和面向切面编程，用简单的Java 对象（Plain Old Java Object，POJO）实现了 EJB 的功能。</p>
<p>虽然 Spring 的组件代码是轻量级的，但它的配置却是重量级的。</p>
<p>所有Spring配置都代表了开发时的损耗。 因为在思考 Spring 特性配置和解决业务问题之间需要进行思维切换，所以写配置挤占了写应用程序逻辑的时间。除此之外，项目的依赖管理也是件吃力不讨好的事情。决定项目里要用哪些库就已经够让人头痛的了，你还要知道这些库的哪个版本和其他库不会有冲突，这难题实在太棘手。并且，依赖管理也是一种损耗，添加依赖不是写应用程序代码。一旦选错了依赖的版本，随之而来的不兼容问题毫无疑问会是生产力杀手。</p>
<p>Spring Boot 让这一切成为了过去。</p>
<p>Spring Boot 简化了基于Spring的应用开发，只需要“run”就能创建一个独立的、生产级别的Spring应用。Spring Boot为Spring平台及第三方库提供开箱即用的设置（提供默认设置），这样我们就可以简单的开始。多数Spring Boot应用只需要很少的Spring配置。 </p>
<p>我们可以使用SpringBoot创建java应用，并使用java –jar 启动它，或者采用传统的war部署方式。  </p>
<p>Spring Boot 主要目标是：</p>
<p>l  为所有 Spring 的开发提供一个从根本上更快的入门体验。</p>
<p>l  开箱即用，但通过自己设置参数，即可快速摆脱这种方式。</p>
<p>l  提供了一些大型项目中常见的非功能性特性，如内嵌服务器、安全、指标，健康检测、外部化配置等。 </p>
<p>l  绝对没有代码生成，也无需 XML 配置。 </p>
<h2 id="2-2-Shiro框架简介"><a href="#2-2-Shiro框架简介" class="headerlink" title="2.2. Shiro框架简介"></a>2.2. Shiro框架简介</h2><p>Apache Shiro是一个强大且易用的Java安全框架，执行身份验证、授权、密码学和会话管理。使用Shiro的易于理解的API,您可以快速、轻松地获得任何应用程序,从最小的移动应用程序到最大的网络和企业应用程序。</p>
<p>Apache Shiro 体系结构 </p>
<p>1、  Authentication 认证 —- 用户登录</p>
<p>2、  Authorization 授权 — 用户具有哪些权限</p>
<p>3、  Cryptography 安全数据加密 </p>
<p>4、  Session Management 会话管理 </p>
<p>5、  Web Integration web系统集成 </p>
<p>6、  Interations 集成其它应用，spring、缓存框架</p>
   <!-- 修改参数 -->       <properties>            <!-- 修改JDK的编译版本为1.8   -->            &lt;java.version&gt;1.8&lt;/java.version&gt;            <!-- 修改thymeleaf的版本 -->            &lt;thymeleaf.version&gt;3.0.2.RELEASE&lt;/thymeleaf.version&gt;            &lt;thymeleaf-layout-dialect.version&gt;2.0.4&lt;/thymeleaf-layout-dialect.version&gt;       </properties><br><br># 4.   Spring Boot与Shiro整合实现用户认证<br><br>## 4.1. 分析Shiro的核心API<br><br>Subject： 用户主体（把操作交给SecurityManager）<br><br>SecurityManager：安全管理器（关联Realm）<br><br>Realm：Shiro连接数据的桥梁<br><br>## 4.2. Spring Boot整合Shiro<br><br>### 4.2.1.   导入shiro与spring整合依赖<br><br>修改pom.xml<br><br><figure class="highlight plain"><figcaption><span>shiro与spring整合依赖 --></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">             &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span><br><span class="line">             &lt;artifactId&gt;shiro-spring&lt;/artifactId&gt;</span><br><span class="line">             &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>​    </p>
<h3 id="4-2-2-自定义Realm类"><a href="#4-2-2-自定义Realm类" class="headerlink" title="4.2.2.   自定义Realm类"></a>4.2.2.   自定义Realm类</h3><p>   <strong>package</strong> com.itheima.shiro;       <strong>import</strong>   org.apache.shiro.authc.AuthenticationException;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationInfo;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationToken;   <strong>import</strong>   org.apache.shiro.authz.AuthorizationInfo;   <strong>import</strong>   org.apache.shiro.realm.AuthorizingRealm;   <strong>import</strong>   org.apache.shiro.subject.PrincipalCollection;       /<strong>    <em> 自定义Realm    </em> </strong>@author<strong> lenovo    <em>    </em>/   </strong>public<strong> </strong>class<strong> UserRealm </strong>extends<strong> AuthorizingRealm{           /</strong>        <em> 执行授权逻辑        </em>/       @Override       <strong>protected</strong> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection arg0) {            System.<strong>out</strong>.println(“执行授权逻辑”);            <strong>return</strong> <strong>null</strong>;       }           /<strong>        <em> 执行认证逻辑        </em>/       @Override       </strong>protected<strong> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken arg0) </strong>throws<strong> AuthenticationException {            System.</strong>out<strong>.println(“执行认证逻辑”);            </strong>return<strong> </strong>null**;       }       }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义Realm</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span></span>&#123; </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行授权逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection arg0)</span> </span>&#123;</span><br><span class="line">         System.out.println(<span class="string">"执行授权逻辑"</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行认证逻辑</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken arg0)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">         System.out.println(<span class="string">"执行认证逻辑"</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-3-编写Shiro配置类（-）"><a href="#4-2-3-编写Shiro配置类（-）" class="headerlink" title="4.2.3.   编写Shiro配置类（*）"></a>4.2.3.   编写Shiro配置类（*）</h3><p>   <strong>package</strong> com.itheima.shiro;       <strong>import</strong>   org.apache.shiro.spring.web.ShiroFilterFactoryBean;   <strong>import</strong>   org.apache.shiro.web.mgt.DefaultWebSecurityManager;   <strong>import</strong>   org.springframework.beans.factory.annotation.Qualifier;   <strong>import</strong>   org.springframework.context.annotation.Bean;   <strong>import</strong> org.springframework.context.annotation.Configuration;       /<strong>    <em> Shiro的配置类    </em> </strong>@author<strong> lenovo    <em>    </em>/   @Configuration   </strong>public<strong> </strong>class<strong> ShiroConfig {           /</strong>        <em> 创建ShiroFilterFactoryBean        </em>/       @Bean       <strong>public</strong> ShiroFilterFactoryBean getShiroFilterFactoryBean(@Qualifier(“securityManager”)DefaultWebSecurityManager securityManager){            ShiroFilterFactoryBean   shiroFilterFactoryBean = <strong>new</strong> ShiroFilterFactoryBean();                        //设置安全管理器            shiroFilterFactoryBean.setSecurityManager(securityManager);                        <strong>return</strong> shiroFilterFactoryBean;       }              /<strong>        <em> 创建DefaultWebSecurityManager        </em>/       @Bean(name=”securityManager”)       </strong>public<strong> DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier(“userRealm”)UserRealm userRealm){            DefaultWebSecurityManager   securityManager = </strong>new<strong> DefaultWebSecurityManager();            //关联realm            securityManager.setRealm(userRealm);            </strong>return<strong> securityManager;       }              /</strong>        <em> 创建Realm        </em>/       @Bean(name=”userRealm”)       <strong>public</strong> UserRealm getRealm(){            <strong>return</strong> <strong>new</strong> UserRealm();       }   }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Shiro的配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lenovo</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">getShiroFilterFactoryBean</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span>DefaultWebSecurityManager securityManager)</span>&#123;</span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//设置安全管理器</span></span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建DefaultWebSecurityManager</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span>(name=<span class="string">"securityManager"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">getDefaultWebSecurityManager</span><span class="params">(@Qualifier(<span class="string">"userRealm"</span>)</span>UserRealm userRealm)</span>&#123;</span><br><span class="line">		DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">		<span class="comment">//关联realm</span></span><br><span class="line">		securityManager.setRealm(userRealm);</span><br><span class="line">		<span class="keyword">return</span> securityManager;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建Realm</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span>(name=<span class="string">"userRealm"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> UserRealm <span class="title">getRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> UserRealm();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-3-使用Shiro内置过滤器实现页面拦截"><a href="#4-3-使用Shiro内置过滤器实现页面拦截" class="headerlink" title="4.3. 使用Shiro内置过滤器实现页面拦截"></a>4.3. 使用Shiro内置过滤器实现页面拦截</h2><p>   <strong>package</strong> com.itheima.shiro;       <strong>import</strong> java.util.LinkedHashMap;   <strong>import</strong> java.util.Map;       <strong>import</strong>   org.apache.shiro.spring.web.ShiroFilterFactoryBean;   <strong>import</strong>   org.apache.shiro.web.mgt.DefaultWebSecurityManager;   <strong>import</strong>   org.springframework.beans.factory.annotation.Qualifier;   <strong>import</strong> org.springframework.context.annotation.Bean;   <strong>import</strong>   org.springframework.context.annotation.Configuration;       /<strong>    <em> Shiro的配置类    </em> </strong>@author<strong> lenovo    <em>    </em>/   @Configuration   </strong>public<strong> </strong>class<strong> ShiroConfig {           /</strong>        <em> 创建ShiroFilterFactoryBean        </em>/       @Bean       <strong>public</strong> ShiroFilterFactoryBean getShiroFilterFactoryBean(@Qualifier(“securityManager”)DefaultWebSecurityManager securityManager){            ShiroFilterFactoryBean   shiroFilterFactoryBean = <strong>new</strong> ShiroFilterFactoryBean();                        //设置安全管理器            shiroFilterFactoryBean.setSecurityManager(securityManager);                       //添加Shiro内置过滤器            /<strong>             <em> Shiro内置过滤器，可以实现权限相关的拦截器             </em>    常用的过滤器：             <em>         anon: 无需认证（登录）可以访问             </em>         authc: 必须认证才可以访问             <em>         user: 如果使用rememberMe的功能可以直接访问             </em>         perms： 该资源必须得到资源权限才可以访问             <em>         role: 该资源必须得到角色权限才可以访问             </em>/            Map&lt;String,String&gt; filterMap = </strong>new<strong>   LinkedHashMap&lt;String,String&gt;();            /<em>filterMap.put(“/add”,   “authc”);            filterMap.put(“/update”,   “authc”);</em>/                        filterMap.put(“/testThymeleaf”, “anon”);                        filterMap.put(“/*”, “authc”);                        //修改调整的登录页面            shiroFilterFactoryBean.setLoginUrl(“/toLogin”);                        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);                                    </strong>return<strong> shiroFilterFactoryBean;       }              /</strong>        <em> 创建DefaultWebSecurityManager        </em>/       @Bean(name=”securityManager”)       <strong>public</strong> DefaultWebSecurityManager getDefaultWebSecurityManager(@Qualifier(“userRealm”)UserRealm userRealm){            DefaultWebSecurityManager   securityManager = <strong>new</strong> DefaultWebSecurityManager();            //关联realm            securityManager.setRealm(userRealm);            <strong>return</strong> securityManager;       }              /<strong>        <em> 创建Realm        </em>/       @Bean(name=”userRealm”)       </strong>public<strong> UserRealm getRealm(){            </strong>return<strong> </strong>new** UserRealm();       }   }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.shiro;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Shiro的配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lenovo</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">getShiroFilterFactoryBean</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span>DefaultWebSecurityManager securityManager)</span>&#123;</span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean(			<span class="comment">//设置安全管理器</span></span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);		</span><br><span class="line">		<span class="comment">//添加Shiro内置过滤器</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Shiro内置过滤器，可以实现权限相关的拦截器</span></span><br><span class="line"><span class="comment">		 *    常用的过滤器：</span></span><br><span class="line"><span class="comment">		 *       anon: 无需认证（登录）可以访问</span></span><br><span class="line"><span class="comment">		 *       authc: 必须认证才可以访问</span></span><br><span class="line"><span class="comment">		 *       user: 如果使用rememberMe的功能可以直接访问</span></span><br><span class="line"><span class="comment">		 *       perms： 该资源必须得到资源权限才可以访问</span></span><br><span class="line"><span class="comment">		 *       role: 该资源必须得到角色权限才可以访问</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Map&lt;String,String&gt; filterMap = <span class="keyword">new</span> LinkedHashMap&lt;String,String&gt;();</span><br><span class="line">		<span class="comment">/*filterMap.put("/add", "authc");</span></span><br><span class="line"><span class="comment">		filterMap.put("/update", "authc");*/</span>		</span><br><span class="line">		filterMap.put(<span class="string">"/testThymeleaf"</span>, <span class="string">"anon"</span>);		</span><br><span class="line">		filterMap.put(<span class="string">"/*"</span>, <span class="string">"authc"</span>);		</span><br><span class="line">		<span class="comment">//修改调整的登录页面</span></span><br><span class="line">		shiroFilterFactoryBean.setLoginUrl(<span class="string">"/toLogin"</span>);		</span><br><span class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);		</span><br><span class="line">		<span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建DefaultWebSecurityManager</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span>(name=<span class="string">"securityManager"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> DefaultWebSecurityManager <span class="title">getDefaultWebSecurityManager</span><span class="params">(@Qualifier(<span class="string">"userRealm"</span>)</span>UserRealm userRealm)</span>&#123;</span><br><span class="line">		DefaultWebSecurityManager securityManager = <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">		<span class="comment">//关联realm</span></span><br><span class="line">		securityManager.setRealm(userRealm);</span><br><span class="line">		<span class="keyword">return</span> securityManager;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建Realm</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span>(name=<span class="string">"userRealm"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> UserRealm <span class="title">getRealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> UserRealm();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-4-实现用户认证（登录）操作"><a href="#4-4-实现用户认证（登录）操作" class="headerlink" title="4.4. 实现用户认证（登录）操作"></a>4.4. 实现用户认证（登录）操作</h2><h3 id="4-4-1-设计登录页面"><a href="#4-4-1-设计登录页面" class="headerlink" title="4.4.1.   设计登录页面"></a>4.4.1.   设计登录页面</h3><p>   &lt;!DOCTYPE html&gt;   <html>   <head>   &lt;meta charset=<em>“UTF-8”</em>&gt;   <title>登录页面</title>   </head>   <body>   <h3>登录</h3>   &lt;form method=<em>“post”</em>   action=<em>“login”</em>&gt;       用户名:&lt;input type=<em>“text”</em>   name=<em>“name”</em>/&gt;<br>       密码：&lt;input type=<em>“password”</em> name=<em>“password”</em>/&gt;<br>       &lt;input type=<em>“submit”</em>   value=<em>“**登录”</em>/&gt;      </body>   </html>   </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span>   <span class="tag">&lt;<span class="name">html</span>&gt;</span>   undefined<span class="tag">&lt;<span class="name">head</span>&gt;</span>   <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span>   <span class="tag">&lt;<span class="name">title</span>&gt;</span>登录页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span>   <span class="tag">&lt;/<span class="name">head</span>&gt;</span>   <span class="tag">&lt;<span class="name">body</span>&gt;</span>   <span class="tag">&lt;<span class="name">h3</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>   <span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span>   <span class="attr">action</span>=<span class="string">"login"</span>&gt;</span>       用户名:<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>   <span class="attr">name</span>=<span class="string">"name"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span>       密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"password"</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span>       <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>   <span class="attr">value</span>=<span class="string">"**登录"</span>/&gt;</span>   <span class="tag">&lt;/<span class="name">form</span>&gt;</span>   <span class="tag">&lt;/<span class="name">body</span>&gt;</span>   <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-4-2-编写Controller的登录逻辑"><a href="#4-4-2-编写Controller的登录逻辑" class="headerlink" title="4.4.2.   编写Controller的登录逻辑"></a>4.4.2.   编写Controller的登录逻辑</h3><p>​           /<strong>        <em> 登录逻辑处理        </em>/       @RequestMapping(“/login”)       </strong>public<strong> String login(String name,String   password,Model model){                        /</strong>             <em> 使用Shiro编写认证操作             </em>/            //1.获取Subject            Subject subject = SecurityUtils.<em>getSubject</em>();                        //2.封装用户数据            UsernamePasswordToken   token = <strong>new</strong> UsernamePasswordToken(name,password);                        //3.执行登录方法            <strong>try</strong> {                subject.login(token);                                //登录成功                //跳转到test.html                <strong>return</strong> “redirect:/testThymeleaf”;            } <strong>catch</strong> (UnknownAccountException e) {                //e.printStackTrace();                //登录失败:用户名不存在                model.addAttribute(“msg”, “用户名不存在”);                <strong>return</strong> “login”;            }<strong>catch</strong> (IncorrectCredentialsException e) {                //e.printStackTrace();                //登录失败:密码错误                model.addAttribute(“msg”, “密码错误”);                <strong>return</strong> “login”;            }       }   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 登录逻辑处理</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@RequestMapping</span>(<span class="string">"/login"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(String name,String password,Model model)</span></span>&#123;	</span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * 使用Shiro编写认证操作</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="comment">//1.获取Subject</span></span><br><span class="line">		Subject subject = SecurityUtils.getSubject();	</span><br><span class="line">		<span class="comment">//2.封装用户数据</span></span><br><span class="line">		UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(name,password);		</span><br><span class="line">		<span class="comment">//3.执行登录方法</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			subject.login(token);		</span><br><span class="line">			<span class="comment">//登录成功</span></span><br><span class="line">			<span class="comment">//跳转到test.html</span></span><br><span class="line">			<span class="keyword">return</span> <span class="string">"redirect:/testThymeleaf"</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnknownAccountException e) &#123;</span><br><span class="line">			<span class="comment">//e.printStackTrace();</span></span><br><span class="line">			<span class="comment">//登录失败:用户名不存在</span></span><br><span class="line">			model.addAttribute(<span class="string">"msg"</span>, <span class="string">"用户名不存在"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">		&#125;<span class="keyword">catch</span> (IncorrectCredentialsException e) &#123;</span><br><span class="line">			<span class="comment">//e.printStackTrace();</span></span><br><span class="line">			<span class="comment">//登录失败:密码错误</span></span><br><span class="line">			model.addAttribute(<span class="string">"msg"</span>, <span class="string">"密码错误"</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="string">"login"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-4-3-编写Realm的判断逻辑"><a href="#4-4-3-编写Realm的判断逻辑" class="headerlink" title="4.4.3.   编写Realm的判断逻辑"></a>4.4.3.   编写Realm的判断逻辑</h3><p>   <strong>package</strong> com.itheima.shiro;       <strong>import</strong>   org.apache.shiro.authc.AuthenticationException;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationInfo;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationToken;   <strong>import</strong>   org.apache.shiro.authc.SimpleAuthenticationInfo;   <strong>import</strong>   org.apache.shiro.authc.UsernamePasswordToken;   <strong>import</strong>   org.apache.shiro.authz.AuthorizationInfo;   <strong>import</strong>   org.apache.shiro.realm.AuthorizingRealm;   <strong>import</strong>   org.apache.shiro.subject.PrincipalCollection;       /<strong>    <em> 自定义Realm    </em> </strong>@author<strong> lenovo    <em>    </em>/   </strong>public<strong> </strong>class<strong> UserRealm </strong>extends<strong> AuthorizingRealm{           /</strong>        <em> 执行授权逻辑        </em>/       @Override       <strong>protected</strong> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection arg0) {            System.<strong>out</strong>.println(“执行授权逻辑”);            <strong>return</strong> <strong>null</strong>;       }           /<strong>        <em> 执行认证逻辑        </em>/       @Override       </strong>protected<strong> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken arg0) </strong>throws<strong> AuthenticationException {            System.</strong>out<strong>.println(“执行认证逻辑”);                        //假设数据库的用户名和密码            String name = “eric”;            String password = “123456”;                        //编写shiro判断逻辑，判断用户名和密码            //1.判断用户名            UsernamePasswordToken   token = (UsernamePasswordToken)arg0;            </strong>if<strong>(!token.getUsername().equals(name)){                //用户名不存在                </strong>return<strong> </strong>null<strong>;//shiro底层会抛出UnKnowAccountException            }                        //2.判断密码            </strong>return<strong> </strong>new** SimpleAuthenticationInfo(“”,password,””);       }       }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义Realm</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> lenovo</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行授权逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection arg0)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"执行授权逻辑"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行认证逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken arg0)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"执行认证逻辑"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//假设数据库的用户名和密码</span></span><br><span class="line">		String name = <span class="string">"eric"</span>;</span><br><span class="line">		String password = <span class="string">"123456"</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//编写shiro判断逻辑，判断用户名和密码</span></span><br><span class="line">		<span class="comment">//1.判断用户名</span></span><br><span class="line">		UsernamePasswordToken token = (UsernamePasswordToken)arg0;</span><br><span class="line">		<span class="keyword">if</span>(!token.getUsername().equals(name))&#123;</span><br><span class="line">			<span class="comment">//用户名不存在</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//shiro底层会抛出UnKnowAccountException</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.判断密码</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(<span class="string">""</span>,password,<span class="string">""</span>);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-5-整合MyBatis实现登录"><a href="#4-5-整合MyBatis实现登录" class="headerlink" title="4.5. 整合MyBatis实现登录"></a>4.5. 整合MyBatis实现登录</h2><h3 id="4-5-1-导入mybatis相关的依赖"><a href="#4-5-1-导入mybatis相关的依赖" class="headerlink" title="4.5.1.   导入mybatis相关的依赖"></a>4.5.1.   导入mybatis相关的依赖</h3>   <!-- 导入mybatis相关的依赖   -->            <dependency>                <groupid>com.alibaba</groupid>                <artifactid>druid</artifactid>                <version>1.0.9</version>            </dependency>            <!-- mysql -->            <dependency>                <groupid>mysql</groupid>                <artifactid>mysql-connector-java</artifactid>            </dependency>            <!-- SpringBoot的Mybatis启动器 -->            <dependency>                <groupid>org.mybatis.spring.boot</groupid>                <artifactid>mybatis-spring-boot-starter</artifactid>                <version>1.1.1</version>            </dependency><br><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;druid&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.0.9&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- mysql --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br><span class="line">		&lt;!-- SpringBoot的Mybatis启动器 --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">			&lt;version&gt;1.1.1&lt;/version&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-2-配置application-properties"><a href="#4-5-2-配置application-properties" class="headerlink" title="4.5.2.   配置application.properties"></a>4.5.2.   配置application.properties</h3><p>位置：src/main/resources目录下</p>
<p>   spring.datasource.driverClassName=com.mysql.jdbc.Driver   spring.datasource.url=jdbc:mysql://localhost:3306/test   spring.datasource.username=root   spring.datasource.password=root       spring.datasource.type=com.alibaba.druid.pool.DruidDataSource       mybatis.type-aliases-package=com.itheima.domain   </p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.driverClassName=com.mysql.jdbc.Driver</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/test</span><br><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=root</span><br><span class="line"></span><br><span class="line">spring.datasource.type=com.alibaba.druid.pool.DruidDataSource</span><br><span class="line"></span><br><span class="line">mybatis.type-aliases-package=com.itheima.domain</span><br></pre></td></tr></table></figure>
<h3 id="4-5-3-编写User实体"><a href="#4-5-3-编写User实体" class="headerlink" title="4.5.3.   编写User实体"></a>4.5.3.   编写User实体</h3><p>   <strong>package</strong> com.itheima.domain;       <strong>public</strong> <strong>class</strong> User {       <strong>private</strong> Integer id;       <strong>private</strong> String name;       <strong>private</strong> String password;       <strong>public</strong> Integer getId() {            <strong>return</strong> id;       }       <strong>public</strong> <strong>void</strong> setId(Integer id) {            <strong>this</strong>.id = id;       }       <strong>public</strong> String getName() {            <strong>return</strong> name;       }       <strong>public</strong> <strong>void</strong> setName(String name) {            <strong>this</strong>.name = name;       }       <strong>public</strong> String getPassword() {            <strong>return</strong> password;       }       <strong>public</strong> <strong>void</strong> setPassword(String password) {            <strong>this</strong>.password = password;       }          }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> Integer id;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String password;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Integer id)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.id = id;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> password;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.password = password;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-4-编写UserMapper接口"><a href="#4-5-4-编写UserMapper接口" class="headerlink" title="4.5.4.   编写UserMapper接口"></a>4.5.4.   编写UserMapper接口</h3><p>   <strong>package</strong> com.itheima.mapper;       <strong>import</strong> com.itheima.domain.User;       <strong>public</strong> <strong>interface</strong> UserMapper {           <strong>public</strong> User   findByName(String name);   }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.itheima.mapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.domain.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-5-编写UserMapper-xml映射文件"><a href="#4-5-5-编写UserMapper-xml映射文件" class="headerlink" title="4.5.5.   编写UserMapper.xml映射文件"></a>4.5.5.   编写UserMapper.xml映射文件</h3><p>   &lt;?xml version=<em>“1.0”</em>   encoding=<em>“UTF-8”</em>   ?&gt;   &lt;!DOCTYPE mapper   PUBLIC “-//mybatis.org//DTD Mapper 3.0//EN”   “<a href="http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;" target="_blank" rel="noopener">http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</a>   <!-- 该文件存放CRUD的sql语句 -->   &lt;mapper namespace=<em>“com.itheima.mapper.UserMapper”</em>&gt;              &lt;select id=<em>“findByName”</em>   parameterType=<em>“string”</em>   resultType=<em>“user”</em>&gt;       SELECT   id,             NAME,             PASSWORD            FROM             user   where name = #{value}             </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE mapper</span></span><br><span class="line"><span class="meta">PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"</span></span><br><span class="line"><span class="meta">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 该文件存放CRUD的sql语句 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.itheima.mapper.UserMapper"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findByName"</span> <span class="attr">parameterType</span>=<span class="string">"string"</span> <span class="attr">resultType</span>=<span class="string">"user"</span>&gt;</span></span><br><span class="line">	SELECT 	id, </span><br><span class="line">		NAME, </span><br><span class="line">		PASSWORD</span><br><span class="line">		FROM </span><br><span class="line">		user where name = #&#123;value&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="4-5-6-编写业务接口和实现"><a href="#4-5-6-编写业务接口和实现" class="headerlink" title="4.5.6.   编写业务接口和实现"></a>4.5.6.   编写业务接口和实现</h3><p>   <strong>package</strong> com.itheima.service.impl;       <strong>import</strong>   org.springframework.beans.factory.annotation.Autowired;   <strong>import</strong>   org.springframework.stereotype.Service;       <strong>import</strong> com.itheima.domain.User;   <strong>import</strong> com.itheima.mapper.UserMapper;   <strong>import</strong>   com.itheima.service.UserService;       @Service   <strong>public</strong> <strong>class</strong> UserServiceImpl <strong>implements</strong> UserService{           //注入Mapper接口       @Autowired       <strong>private</strong> UserMapper userMapper;              @Override       <strong>public</strong> User   findByName(String name) {            <strong>return</strong> userMapper.findByName(name);       }              }       </p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">接口：</span><br><span class="line"><span class="keyword">package</span> com.itheima.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.domain.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findByName</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实现:</span><br><span class="line"><span class="keyword">package</span> com.itheima.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.itheima.domain.User;</span><br><span class="line"><span class="keyword">import</span> com.itheima.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.itheima.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserService</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//注入Mapper接口</span></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">findByName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> userMapper.findByName(name);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-7-添加-MapperScan注解"><a href="#4-5-7-添加-MapperScan注解" class="headerlink" title="4.5.7.   添加@MapperScan注解"></a>4.5.7.   添加@MapperScan注解</h3><p>   <strong>package</strong> com.itheima;       <strong>import</strong>   org.mybatis.spring.annotation.MapperScan;   <strong>import</strong>   org.springframework.boot.SpringApplication;   <strong>import</strong>   org.springframework.boot.autoconfigure.SpringBootApplication;       /<strong>    <em> SpringBoot启动类    </em> </strong>@author<strong> lenovo    <em>    </em>/   @SpringBootApplication   @MapperScan(“com.itheima.mapper”)   </strong>public<strong> </strong>class<strong> Application {           </strong>public<strong> </strong>static<strong> </strong>void<strong> main(String[] args) {            SpringApplication.<em>run</em>(Application.</strong>class**, args);       }   }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.itheima.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(Application.class, args);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-8-修改UserRealm"><a href="#4-5-8-修改UserRealm" class="headerlink" title="4.5.8.   修改UserRealm"></a>4.5.8.   修改UserRealm</h3><p>   <strong>package</strong> com.itheima.shiro;       <strong>import</strong>   org.apache.shiro.authc.AuthenticationException;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationInfo;   <strong>import</strong>   org.apache.shiro.authc.AuthenticationToken;   <strong>import</strong>   org.apache.shiro.authc.SimpleAuthenticationInfo;   <strong>import</strong>   org.apache.shiro.authc.UsernamePasswordToken;   <strong>import</strong>   org.apache.shiro.authz.AuthorizationInfo;   <strong>import</strong>   org.apache.shiro.realm.AuthorizingRealm;   <strong>import</strong>   org.apache.shiro.subject.PrincipalCollection;   <strong>import</strong>   org.springframework.beans.factory.annotation.Autowired;       <strong>import</strong> com.itheima.domain.User;   <strong>import</strong>   com.itheima.service.UserService;       /<strong>    <em> 自定义Realm    </em> </strong>@author<strong> lenovo    <em>    </em>/   </strong>public<strong> </strong>class<strong> UserRealm </strong>extends<strong> AuthorizingRealm{           /</strong>        <em> 执行授权逻辑        </em>/       @Override       <strong>protected</strong> AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection arg0) {            System.<strong>out</strong>.println(“执行授权逻辑”);            <strong>return</strong> <strong>null</strong>;       }              @Autowired       <strong>private</strong> UserService userSerivce;           /<strong>        <em> 执行认证逻辑        </em>/       @Override       </strong>protected<strong> AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken arg0) </strong>throws<strong> AuthenticationException {            System.</strong>out<strong>.println(“执行认证逻辑”);                        //编写shiro判断逻辑，判断用户名和密码            //1.判断用户名            UsernamePasswordToken   token = (UsernamePasswordToken)arg0;                        User user = userSerivce.findByName(token.getUsername());                        </strong>if<strong>(user==</strong>null<strong>){                //用户名不存在                </strong>return<strong> </strong>null<strong>;//shiro底层会抛出UnKnowAccountException            }                        //2.判断密码            </strong>return<strong> </strong>new** SimpleAuthenticationInfo(“”,user.getPassword(),””);       }       }       </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserRealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行授权逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection arg0)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"执行授权逻辑"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userSerivce;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行认证逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken arg0)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"执行认证逻辑"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//编写shiro判断逻辑，判断用户名和密码</span></span><br><span class="line">		<span class="comment">//1.判断用户名</span></span><br><span class="line">		UsernamePasswordToken token = (UsernamePasswordToken)arg0;</span><br><span class="line">		</span><br><span class="line">		User user = userSerivce.findByName(token.getUsername());</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(user==<span class="keyword">null</span>)&#123;</span><br><span class="line">			<span class="comment">//用户名不存在</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;<span class="comment">//shiro底层会抛出UnKnowAccountException</span></span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//2.判断密码</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> SimpleAuthenticationInfo(<span class="string">""</span>,user.getPassword(),<span class="string">""</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5-Spring-Boot与Shiro整合实现用户授权"><a href="#5-Spring-Boot与Shiro整合实现用户授权" class="headerlink" title="5.   Spring Boot与Shiro整合实现用户授权"></a>5.   Spring Boot与Shiro整合实现用户授权</h1><h2 id="5-1-使用Shiro内置过滤器拦截资源"><a href="#5-1-使用Shiro内置过滤器拦截资源" class="headerlink" title="5.1. 使用Shiro内置过滤器拦截资源"></a>5.1. 使用Shiro内置过滤器拦截资源</h2><p>   /<strong>        <em> 创建ShiroFilterFactoryBean        </em>/       @Bean       </strong>public<strong> ShiroFilterFactoryBean getShiroFilterFactoryBean(@Qualifier(“securityManager”)DefaultWebSecurityManager securityManager){            ShiroFilterFactoryBean   shiroFilterFactoryBean = </strong>new<strong> ShiroFilterFactoryBean();                        //设置安全管理器            shiroFilterFactoryBean.setSecurityManager(securityManager);                        //添加Shiro内置过滤器            /</strong>             <em> Shiro内置过滤器，可以实现权限相关的拦截器             </em>    常用的过滤器：             <em>         anon: 无需认证（登录）可以访问             </em>         authc: 必须认证才可以访问             <em>         user: 如果使用rememberMe的功能可以直接访问             </em>         perms： 该资源必须得到资源权限才可以访问             <em>         role: 该资源必须得到角色权限才可以访问             </em>/            Map&lt;String,String&gt;   filterMap = <strong>new</strong>   LinkedHashMap&lt;String,String&gt;();            /<em>filterMap.put(“/add”,   “authc”);            filterMap.put(“/update”,   “authc”);</em>/                        filterMap.put(“/testThymeleaf”, “anon”);            //放行login.html页面            filterMap.put(“/login”, “anon”);                        //授权过滤器            //注意：当前授权拦截后，shiro会自动跳转到未授权页面            filterMap.put(“/add”, “perms[user:add]”);                        filterMap.put(“/*”, “authc”);                        //修改调整的登录页面            shiroFilterFactoryBean.setLoginUrl(“/toLogin”);            //设置未授权提示页面            shiroFilterFactoryBean.setUnauthorizedUrl(“/noAuth”);                        shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);                                    <strong>return</strong> shiroFilterFactoryBean;       }   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 创建ShiroFilterFactoryBean</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">getShiroFilterFactoryBean</span><span class="params">(@Qualifier(<span class="string">"securityManager"</span>)</span>DefaultWebSecurityManager securityManager)</span>&#123;</span><br><span class="line">		ShiroFilterFactoryBean shiroFilterFactoryBean = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//设置安全管理器</span></span><br><span class="line">		shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//添加Shiro内置过滤器</span></span><br><span class="line">		<span class="comment">/**</span></span><br><span class="line"><span class="comment">		 * Shiro内置过滤器，可以实现权限相关的拦截器</span></span><br><span class="line"><span class="comment">		 *    常用的过滤器：</span></span><br><span class="line"><span class="comment">		 *       anon: 无需认证（登录）可以访问</span></span><br><span class="line"><span class="comment">		 *       authc: 必须认证才可以访问</span></span><br><span class="line"><span class="comment">		 *       user: 如果使用rememberMe的功能可以直接访问</span></span><br><span class="line"><span class="comment">		 *       perms： 该资源必须得到资源权限才可以访问</span></span><br><span class="line"><span class="comment">		 *       role: 该资源必须得到角色权限才可以访问</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		Map&lt;String,String&gt; filterMap = <span class="keyword">new</span> LinkedHashMap&lt;String,String&gt;();</span><br><span class="line">		<span class="comment">/*filterMap.put("/add", "authc");</span></span><br><span class="line"><span class="comment">		filterMap.put("/update", "authc");*/</span></span><br><span class="line">		</span><br><span class="line">		filterMap.put(<span class="string">"/testThymeleaf"</span>, <span class="string">"anon"</span>);</span><br><span class="line">		<span class="comment">//放行login.html页面</span></span><br><span class="line">		filterMap.put(<span class="string">"/login"</span>, <span class="string">"anon"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//授权过滤器</span></span><br><span class="line">		<span class="comment">//注意：当前授权拦截后，shiro会自动跳转到未授权页面</span></span><br><span class="line">		filterMap.put(<span class="string">"/add"</span>, <span class="string">"perms[user:add]"</span>);</span><br><span class="line">		</span><br><span class="line">		filterMap.put(<span class="string">"/*"</span>, <span class="string">"authc"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//修改调整的登录页面</span></span><br><span class="line">		shiroFilterFactoryBean.setLoginUrl(<span class="string">"/toLogin"</span>);</span><br><span class="line">		<span class="comment">//设置未授权提示页面</span></span><br><span class="line">		shiroFilterFactoryBean.setUnauthorizedUrl(<span class="string">"/noAuth"</span>);</span><br><span class="line">		</span><br><span class="line">		shiroFilterFactoryBean.setFilterChainDefinitionMap(filterMap);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h2 id="5-2-完成Shiro的资源授权"><a href="#5-2-完成Shiro的资源授权" class="headerlink" title="5.2. 完成Shiro的资源授权"></a>5.2. 完成Shiro的资源授权</h2><p>UserRealm:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 执行授权逻辑</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection arg0)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"执行授权逻辑"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//给资源进行授权</span></span><br><span class="line">		SimpleAuthorizationInfo info = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//添加资源的授权字符串</span></span><br><span class="line">		info.addStringPermission(<span class="string">"user:add"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> info;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/mysql知识点整理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/25/mysql知识点整理/" itemprop="url">MySQL知识点整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T11:51:56+08:00">
                2019-02-25
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2019/02/25/mysql知识点整理/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2019/02/25/mysql知识点整理/" class="cy_cmt_count" data-xid="2019/02/25/mysql知识点整理/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一、MySQL的逻辑架构"><a href="#一、MySQL的逻辑架构" class="headerlink" title="一、MySQL的逻辑架构"></a>一、MySQL的逻辑架构</h1><p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/mysql/mysql%E7%9A%84%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84.png" alt="mysql的逻辑结构"></p>
<p>简单来说mysql分为Server层和存储引擎层</p>
<p>Server层包括连接器、查询缓存、分析器、优化器、执行器等，涵盖mysql的大部分服务功能，以及所有的内置函数，所有的跨存储引擎的功能都在这一层，比如存储过程、视图等。</p>
<p>存储引擎层提供读写数据的接口，常用存储引擎包括InnoDB、MyISAM、Memory等，5.5之后默认的是InnoDB。</p>
<p>下面解释下每个组件的作用：</p>
<p>##连接器</p>
<p>当你使用类似这样的命令<code>mysql -h127.0.0.1 - P3306 -uroot -p123456</code>去连接数据库的时候，接待你的就是连接器。连接器负责创建连接、获取权限、维持和管理连接。</p>
<p>（1）流程如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用户发起连接请求-&gt;TCP握手-&gt;输入密码（如果还没输入的话）-&gt;连接器去权限表获取权限-&gt;依赖于得到的权限进行查询</span><br></pre></td></tr></table></figure>
<p>这就意味着，一个用户成功建立连接后，即使你用管理员账号修改这个用户的权限，在这个连接中用户还是原来的权限。</p>
<p>（2）常用查看命令：</p>
<ul>
<li>show processlist：可以查看已经创建的连接</li>
</ul>
<p>（3）有关参数：</p>
<ul>
<li>wati_timeout ：空闲连接的连接时间最久可以是多少</li>
</ul>
<p>（4）什么是长连接、短连接：<br>长连接：是指用户创建一个连接后，如果持续有请求，则一直使用同一个连接</p>
<p>短连接：每次只执行很少的操作就断开连接，下次再重新创建连接。</p>
<p>（5）长连接有什么好处？缺点呢？<br>好处：创建连接的代价通常是高的，使用长连接减少连接开销代价。</p>
<p>缺点：使用长连接，连接对象中占用的内存会一直积压，直到释放连接才释放，如果内存占用太多，会被系统强制杀掉，导致mysql异常重启。</p>
<p>（6）怎么解决长连接的内存问题？</p>
<ul>
<li><p>定期断开长连接。</p>
</li>
<li><p>如果使用的是mysql5.7以上的版本，可以在一次比较大的操作后，使用<code>mysql_reset_connection</code>,这个操作不会断开连接，而是将连接恢复到刚创建时的状态。</p>
</li>
</ul>
<h2 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h2><p>因为mysql的会把sql语句和返回值缓存成key-value的形式。创建连接之后，执行select语句，会先查询mysql的缓存中有没有这条语句，有就返回value，没有就执行后面步骤。</p>
<p>（1）要不要开启mysql的缓存功能？<br>对于那些不经常变动的表，可以开启缓存，对于频繁变动的表，关闭缓存。因为每次表的数据发生了变化，这个表的所有缓存就会失效，这样的话缓存起不来什么作用还会增加了开销。</p>
<p>（2）怎么开启缓存、关闭缓存？</p>
<p>通过<code>query_cache_type</code>开启和关闭缓存；</p>
<p>还可以在每条select语句中的select后面加上<code>SQL_CACHE</code>、<code>SQL_NO_CACHE</code>来指定这条sql语句开启和不开启缓存。</p>
<p>需要注意的是MySQL8.0已经彻底去掉了缓存这个功能了。</p>
<h2 id="分析器"><a href="#分析器" class="headerlink" title="分析器"></a>分析器</h2><p>进行词法分析和语法分析</p>
<p>词法分析主要分析分析出sql语句中的字符串分别是什么，代表什么，比如selete后面的代表字段，from后面的代表表。另外检查要操作的表存不存在或者这个列存不存在也是在这里。</p>
<p>语法分析主要分析执行的sql语句是否符合sql的语法规定。</p>
<p>##优化器</p>
<p>优化器是在有多个索引的时候决定使用那个索引，连表查询的时候决定各表的连接顺序。</p>
<p>同样的执行结果，根据sql语句内查询顺序不一样执行效率会不同，由优化器来决定使用哪种方案。</p>
<h2 id="执行器"><a href="#执行器" class="headerlink" title="执行器"></a>执行器</h2><p>执行步骤：<br>判断权限-&gt;去存储引擎获取数据返回-&gt;如果满足条件，继续去存储引擎的下一行-&gt;将满足的行的结果集返回</p>
<p>（1）我们怎么知道执行器扫描了多少行？</p>
<p>慢查询日志的<code>rows_examined</code>字段就是表示这个语句在执行的时候扫描了多少行的。</p>
<p>还可以通过<code>explain</code>的<code>row</code>字段查看。</p>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>（1）MyISAM和InnoDB的区别是什么？</p>
<ul>
<li>MyISAM不是事务安全的，不支持外键。</li>
<li>MyISAM只支持表锁，不支持行锁</li>
<li>InnoDB是事务型引擎，具有崩溃回复能力，多版本并发控制（MVCC），支持ACID事务，支持行级锁定，锁管理开销大。</li>
<li>MyISAM表相对简单，管理方便，因此在效率上优于InnoDB，小型应用可以考虑使用MyISAM。</li>
<li>InnoDB比MyISAM更加安全，可以保证数据不会丢失的情况下，切换非事务表到事务表。</li>
</ul>
<p>#二、日志系统：一条sql更新操作是怎么执行的</p>
<p>mysql有两种日志redo-log和bin-log</p>
<p><strong>（1）redo-log是怎么工作的？</strong></p>
<p>执行更新操作的时候，InnoDB引擎先将记录写到redo-log里，然后更新内存，这时候更新操作就算完成了。然后在适当的时候再将redo-log中的内容写到磁盘的数据文件中，这个时机往往是系统比较空闲的时候或者redo-log已经写满了得时候。</p>
<p>有了redo-log，InnoDB就可以保证即时数据库发送异常重启，也能从redo-log中恢复数据，这个能力叫做crash-safe。</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/mysql/redo-log.jpg" alt=""></p>
<p><strong>（2）为什么要有两种日志？</strong><br>①因为redo-log是InnoDB特有的，所以要有bin-log给其他引擎使用；</p>
<p>②redo-log是循环写的，不能持久化，bin-log是可以追加写的，一个文件写满了后可以写到下一个，提供了redo-log没有的“归档”的功能。</p>
<p><strong>（3）redo-log和bin-log的区别</strong></p>
<ul>
<li>redo-log是InnoDB特有的，bin-log在Server层可以给其他引擎使用</li>
<li>redo-log是物理日志，记录的是在”某个数据页做了什么修改“；bin-log是逻辑日志，记录的是原始语句的逻辑，例如“给id=2这一行的c加1”这样的</li>
<li>redo log 是循环写的,空间固定会用完;binlog 是可以追加写入的。“追加写”是指 bin-log文件写到一定大小会写到写一个文件，不会覆盖写的。</li>
</ul>
<p><strong>（4）redo-log和bin-log怎么保持一致？</strong></p>
<p>使用两阶段提交的方式。</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/mysql/redo-log%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A4.png" alt=""></p>
<p>上面的流程，写入redolog的时候先是prepare阶段，写完binlog后，再将redolog写入的变成commit状态，这样即使写入的途中redolog或binlog有一个突然崩溃了没写入，类似事务，可以通过让redolog回滚的方法来保证一致性。</p>
<p><strong>（5）bin-log有哪两种存储形式？</strong><br>row：存储的是更新前和更新后的两行数据<br>statement：存储的是执行的语句</p>
<p><strong>（6）怎么开启bin-log？</strong><br>使用参数<code>sql_log_bin</code>开启和关闭bin-log</p>
<h1 id="三、事务"><a href="#三、事务" class="headerlink" title="三、事务"></a>三、事务</h1><p><strong>（1）事务的四个特性是什么？</strong></p>
<ul>
<li>原子性（Atomicity）:同一个事物中的操作要么全部成功，要么全部失败</li>
<li>一致性（Consistency）：事务必须保持系统属于一致的状态，就像能量守恒一样，自然界中获得的能量和失去能量总是一样的。</li>
<li>隔离性（Isolation）：各个事务执行的时候不会相互影响的性质</li>
<li>持久性（Durability）：在事务完成以后，该事务对数据库所作的更改便持久的保存在数据库之中，并不会被回滚。</li>
</ul>
<p><strong>（2）mysql的有哪些事务隔离级别？</strong></p>
<ul>
<li>读未提交（read uncommited）：一个事务可以读到另一个事务未提交的数据</li>
<li>读提交（read commited）：一个事务只能读到另一个事务提交的数据</li>
<li>【MySQL默认】可重复读（repeatable read）：一个事务读到的数据和事务刚开始的时候是一样的</li>
<li>序列化（serializable）：对同一行数据，读的时候加读锁，写的时候加写锁，如果发生了读写锁冲突，则让前面的事务先执行完后面的才能执行</li>
</ul>
<p><strong>（3）使用各个事务隔离级别各有什么缺点？</strong></p>
<ul>
<li>使用读未提交会读取到脏数据，如果下一秒有事务发送了回滚，那么先前读到的数据就是脏的。</li>
<li>使用读提交可能会出现不可重复读的情况，当前读到的数据，下一秒可能会发生变化。</li>
<li>可重复读可能出现幻读，就是之前没有读到的数据，在有事务插入数据后，再读一次会有多出来的数据，但是使用了MVCC之后，这个问题已经解决了</li>
<li>序列化很明显性能不高</li>
</ul>
<p><strong>（4）怎么设置事务隔离级别？</strong></p>
<p>通过参数<code>tx_isolation</code>来设置（5.7之后是<code>transaction_isolation</code>）</p>
<p><strong>（5）什么是MVCC？（多版本并发控制）</strong></p>
<p>MVCC是通过及时保存每个事务的快照来实现的。这意味着同一个事务在运行时看到的数据视图是一致的，而同一个时间，同一张表，不同事务之间看到的数据是不同的。</p>
<p>具体是这样实现的：</p>
<p>InnoDB会给每个事务一个版本号，给维护每行数据两个数值：当前版本号和过期版本号，当前版本号每次有新事务就递增。每个事务只能读到比自己版本旧的数据或者或者在自己版本之前被删除的数据，删除数据的时候把自己的版本号赋值给这一行的过期版本号，读到的数据作为这个事务的快照；更新数据的时候先复制一行旧数据，再用自己的版本号给旧数据加上删除的版本号，给新数据加上当前版本号</p>
<p><strong>（6）为什么不要使用长事务？</strong></p>
<p>在事务中每个操作都要记录前一个状态以进行回滚，如果事务过长，回滚段就会一直增加，导致占用大量的存储空间。同时长事务会长时间占用锁资源，拖垮数据库。</p>
<h1 id="四、索引"><a href="#四、索引" class="headerlink" title="四、索引"></a>四、索引</h1><p>1.索引的作用：提高数据查询效率。<br>2.常见索引模型：哈希表、有序数组、搜索树。<br>3.哈希表：键 - 值(key - value)。<br>4.哈希思路：把值放在数组里，用一个哈希函数把key换算成一个确定的位置，然后把value放在数组的这个位置。<br>5.哈希冲突的处理办法：链表。<br>6.哈希表适用场景：只有等值查询的场景，<strong>如果要进行范围查询，需要进行全表扫描</strong>。<br>7.有序数组：按顺序存储。查询用二分法就可以快速查询，时间复杂度是：O(log(N))<br>8.有序数组查询效率高，更新效率低，更新的时候需要移动后面的元素。<br>9.有序数组的适用场景：静态存储引擎。<br>10.二叉搜索树：每个节点的左儿子小于父节点，父节点又小于右儿子。<br>11.二叉搜索树：查询时间复杂度O(log(N))，更新时间复杂度O(log(N))。<br>12.数据库存储大多不适用二叉树，<strong>因为树高过高</strong>，会适用N叉树。<br>13.InnoDB中的索引模型：<strong>B+Tree</strong>。<br>14.索引类型：主键索引、非主键索引，<strong>主键索引的叶子节点存的是整行的数据(聚簇索引)，非主键索引的叶子节点内容是主键的值(二级索引)。</strong><br>15.主键索引和普通索引的区别：主键索引只要搜索ID这个B+Tree即可拿到数据。普通索引先搜索索引拿到主键值，再到主键索引树搜索一次(<strong>回表</strong>)<br>16.一个数据页满了，按照B+Tree算法，新增加一个数据页，叫做<strong>页分裂</strong>，会导致性能下降。空间利用率降低大概50%。当相邻的两个数据页利用率很低的时候会做数据<strong>页合并</strong>，合并的过程是分裂过程的逆过程。</p>
<p>17.从性能和存储空间方面考量，<strong>自增主键</strong>往往是更合理的选择，因为自增主键小，那个普通索引的叶子节点是自主主键，普通索引的B+树占用的空间就小。</p>
<p>18.覆盖索引：建立联合索引，让联合索引覆盖要查询的字段</p>
<p>19.最左前缀：联合索引中只有前面的字段满足使用索引的条件，才使用后面的字段索引</p>
<h1 id="五、一些mysql性能调优的建议"><a href="#五、一些mysql性能调优的建议" class="headerlink" title="五、一些mysql性能调优的建议"></a>五、一些mysql性能调优的建议</h1><p>（1）最主要的部分应该是sql语句调优：</p>
<p>合理使用索引：</p>
<ol start="0">
<li>如果可以的话给频繁用来查询的字段加上索引，加快查询速度。</li>
<li>必要时可以添加联合索引，来覆盖返回结果。</li>
<li>注意最左前缀匹配，保证查询的sql语句按照创建的索引顺序来查找，避免创建冗余索引</li>
<li>用like进行模糊查询的时候不要使用‘%like%’，而尽量使用‘like%’的形式。另外使用regexp也是不会使用索引的。</li>
<li>如果字段使用了函数或者运算操作是不会使用索引的</li>
<li>多使用explain去分析sql语句</li>
<li>使用union代替or，因为or很多时候是不会使用索引的</li>
</ol>
<p>（2）配置调优</p>
<ol start="0">
<li>选择合适的存储引擎，如果是一个不经常修改的表，而且不需要事务的支持，而且这个表经常要count（*），可以使用MyISAM，因为MyISAM没有行锁、事务这些东西，相对简单，性能更优。</li>
<li>对于修改频繁的表关闭mysql的缓存功能，因为如果这个表有修改的话，所有缓存都会失效，缓存没起到什么作用，反而加大了维护缓存的开销（配置query_cache_type）</li>
<li>开启slow_query_log慢查询日志，long_query_time可以根据业务设置，分析执行缓慢的sql语句</li>
<li>对于频繁操作数据库的业务，连接的时候wati_timeout 可以设置大一些，避免频繁创建连接</li>
<li>使用连接池</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/16/Spring-AOP理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/16/Spring-AOP理解/" itemprop="url">Spring AOP理解</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-16T22:29:18+08:00">
                2018-12-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/12/16/Spring-AOP理解/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/12/16/Spring-AOP理解/" class="cy_cmt_count" data-xid="2018/12/16/Spring-AOP理解/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="为什么用AOP？"><a href="#为什么用AOP？" class="headerlink" title="为什么用AOP？"></a>为什么用AOP？</h2><p>解决OOP的缺点，不用在特定业务的方法中显式调用与业务无关的代码。使用生成代理类的方式实现横切代码的调用。</p>
<h2 id="AOP的实现"><a href="#AOP的实现" class="headerlink" title="AOP的实现"></a>AOP的实现</h2><p>aop有两种实现方式，一种是使用AspectJ在编译期静态生成代理类，另一种是使用CGLIB或JDK动态代理在运行期动态生成代理类。Spring AOP的选择方式是，如果要代理的类实现了接口，就使用JDK动态代理，否则使用CGLIB。</p>
<h3 id="AOP中的抽象概念"><a href="#AOP中的抽象概念" class="headerlink" title="AOP中的抽象概念"></a>AOP中的抽象概念</h3><p>连接点（join point）：可以被拦截的目标方法。</p>
<p>切点（point cut）:指定的要进行切入的连接点。</p>
<p>通知（advice）：切点的前后或环绕要执行的动作。</p>
<p>切面（aspect）：由切点和通知组成，定义通知应用带哪个切点上。</p>
<p>织入（weaving）：把切面的代码应用到目标方法的过程。</p>
<h3 id="通知（advice）分为下面5种"><a href="#通知（advice）分为下面5种" class="headerlink" title="通知（advice）分为下面5种"></a>通知（advice）分为下面5种</h3><ul>
<li>before 目标方法执行前通知，前置通知</li>
<li>after 后置通知</li>
<li>after throwing：目标方法抛出异常时执行，异常通知</li>
<li>after returning：目标方法成功返回值时执行，后置返回通知。（after是不管是否成功返回都是执行）</li>
<li>around：在目标函数执行中执行，可控制目标函数是否执行，环绕通知</li>
</ul>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/12/16/Spring-AOP理解/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/09/mybatis学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/09/mybatis学习/" itemprop="url">mybatis学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-09T22:54:54+08:00">
                2018-12-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/12/09/mybatis学习/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/12/09/mybatis学习/" class="cy_cmt_count" data-xid="2018/12/09/mybatis学习/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="1-JDBC编程有哪些不足之处，MyBatis是如何解决这些问题的？"><a href="#1-JDBC编程有哪些不足之处，MyBatis是如何解决这些问题的？" class="headerlink" title="1.JDBC编程有哪些不足之处，MyBatis是如何解决这些问题的？"></a>1.JDBC编程有哪些不足之处，MyBatis是如何解决这些问题的？</h2><p>① 数据库链接创建、释放频繁造成系统资源浪费从而影响系统性能，如果使用数据库链接池可解决此问题。</p>
<p>解决：在SqlMapConfig.xml中配置数据链接池，使用连接池管理数据库链接。</p>
<p>② Sql语句写在代码中造成代码不易维护，实际应用sql变化的可能较大，sql变动需要改变java代码。</p>
<p>解决：将Sql语句配置在XXXXmapper.xml文件中与java代码分离。</p>
<p>③ 向sql语句传参数麻烦，因为sql语句的where条件不一定，可能多也可能少，占位符需要和参数一一对应。</p>
<p>解决： Mybatis自动将java对象映射至sql语句。</p>
<p>④ 对结果集解析麻烦，sql变化导致解析代码变化，且解析前需要遍历，如果能将数据库记录封装成pojo对象解析比较方便。</p>
<p>解决：Mybatis自动将sql执行结果映射至java对象。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/12/09/mybatis学习/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/09/ResultSet的4种类型/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/09/ResultSet的4种类型/" itemprop="url">ResultSet的4种类型</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-09T20:28:10+08:00">
                2018-12-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/12/09/ResultSet的4种类型/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/12/09/ResultSet的4种类型/" class="cy_cmt_count" data-xid="2018/12/09/ResultSet的4种类型/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="ResultSet的4种类型"><a href="#ResultSet的4种类型" class="headerlink" title="ResultSet的4种类型"></a>ResultSet的4种类型</h1><h2 id="FORWARD-ONLY"><a href="#FORWARD-ONLY" class="headerlink" title="FORWARD_ONLY"></a>FORWARD_ONLY</h2><p>这是最基本的ResultSet，这个ResultSet他起到的作用就是完成了查询结果的存储功能，而且只能读取一次，不能够来回的滚动读取。这种结果集的创建方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Statement st = conn.CreateStatement()</span><br><span class="line">ResultSet rs = Statement.excuteQuery(sqlStr);</span><br></pre></td></tr></table></figure>
<p>由于这种结果集不支持，滚动的读去功能所以，如果获得这样一个结果集，只能使用它里面的next()方法，逐个的读去数据。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/12/09/ResultSet的4种类型/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/08/redis学习/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/08/redis学习/" itemprop="url">redis学习</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-08T22:58:42+08:00">
                2018-12-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/12/08/redis学习/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/12/08/redis学习/" class="cy_cmt_count" data-xid="2018/12/08/redis学习/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="Redis学习"><a href="#Redis学习" class="headerlink" title="Redis学习"></a>Redis学习</h1><p>##1、redis是什么</p>
<p>redis是一种支持Key-Value等多种数据结构的存储系统。可用于缓存、事件发布或订阅、高速队列等场景。该数据库使用ANSI C语言编写，支持网络，提供字符串、哈希、列表、队列、集合结构直接存取，基于内存，可持久化。</p>
<h2 id="2-redis的应用场景"><a href="#2-redis的应用场景" class="headerlink" title="2.redis的应用场景"></a>2.redis的应用场景</h2><ul>
<li>会话缓存（最常用）</li>
<li>消息队列，比如支付</li>
<li>活动排行榜或计数</li>
<li>发布、订阅消息（消息通知）</li>
<li>商品列表、评论列表等</li>
</ul>
<h2 id="3-redis的数据类型"><a href="#3-redis的数据类型" class="headerlink" title="3.redis的数据类型"></a>3.redis的数据类型</h2><p>redis一共支持五种数据类：string(字符串)、hash(哈希)、list(列表)、set(集合)和zset（sorted set 有序集合）。</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/12/08/redis学习/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/30/排序算法/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/30/排序算法/" itemprop="url">排序算法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-30T19:57:22+08:00">
                2018-11-30
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/11/30/排序算法/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/11/30/排序算法/" class="cy_cmt_count" data-xid="2018/11/30/排序算法/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h1><p>排序方法可分为5类：</p>
<ul>
<li>交换排序：对无序区中的记录的关键字两两比较，若逆序则交换，直到关键字之间不再逆序，典型的有冒泡排序、快速排序</li>
<li>选择排序：在无序区中选出关键字最小的记录，置于有序区后面，直到所有记录有序，典型的有简单选择排序、堆排序</li>
<li>插入排序：将无序区中的一个记录插入至有序区，使得有序区的长度加1，直到所有记录有序，典型的有直接插入排序、希尔排序</li>
<li>归并排序：是不断将两个或两个以上有序区合并成一个有序区，直到全部记录有序</li>
<li>基数排序：基数排序是按照低位先排序，然后收集；再按照高位排序，然后再收集；依次类推，直到最高位。</li>
</ul>
<p>排序方法可按时间复杂度分为下面4类：</p>
<ul>
<li>简单的排序方法：O（n^2）</li>
<li>先进的排序方法：O（nlogn）</li>
<li>基数排序，时间复杂度为O（n）</li>
<li>希尔排序介于1和2之间</li>
</ul>
<p>具体如下：</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/849589-20180402133438219-1946132192.png" alt="时间复杂度"></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/11/30/排序算法/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/20/JAVA集合框架/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/20/JAVA集合框架/" itemprop="url">JAVA集合框架</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-20T19:57:22+08:00">
                2018-11-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/11/20/JAVA集合框架/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/11/20/JAVA集合框架/" class="cy_cmt_count" data-xid="2018/11/20/JAVA集合框架/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>#JAVA集合框架</p>
<p>java三大集合框架 :  Set  List   Map</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/20170714230605815.jpg" alt="20170714230605815"></p>
<p>如上图 Set List 都属于Collection的子接口(Collection为顶层接口) Map 不属于Collection接口</p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2018/11/20/JAVA集合框架/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/Java内存模型与线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/13/Java内存模型与线程/" itemprop="url">Java内存模型与线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-13T19:56:56+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/09/13/Java内存模型与线程/#SOHUCS" itemprop="discussionUrl">
                  <span id="url::http://yoursite.com/2018/09/13/Java内存模型与线程/" class="cy_cmt_count" data-xid="2018/09/13/Java内存模型与线程/" itemprop="commentsCount" ></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="硬件的效率与一致性"><a href="#硬件的效率与一致性" class="headerlink" title="硬件的效率与一致性"></a>硬件的效率与一致性</h2><p>在正式了解Java虚拟机并发相关知识前，需要先花费一点时间去了解下物理计算机中的并发问题。</p>
<p>由于计算机的存储设备与处理器的运算速度存在几个数量级的差距，于是加入了高速缓存来作为内存与处理器之间的缓冲：<strong>将运算需要使用的数据复制到缓存中，让运算能快速进行，当运算结束后再从缓存同步回内存中，这样处理器就无须等待缓慢的内存读写了。</strong>但这也引入了缓存一致性的问题，即每个处理器都有自己的一个高速缓存，那么同步相同数据回主内存的时候以谁为准。这里需要使用一些缓存一致性协议来处理。</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E3%80%81%E4%B8%BB%E5%86%85%E5%AD%98.jpg" alt=""></p>
<h2 id="Java内存模型（JMM）"><a href="#Java内存模型（JMM）" class="headerlink" title="Java内存模型（JMM）"></a>Java内存模型（JMM）</h2><p>让Java在各种平台都能达到一致的内存访问效果。</p>
<h3 id="主内存和工作内存"><a href="#主内存和工作内存" class="headerlink" title="主内存和工作内存"></a>主内存和工作内存</h3><p>JMM规定了所有变量都存储在主内存，每个线程有自己的工作内存，线程对变量的操作必须在工作内存，而不能直接读写主内存中的变量，不同线程之间的工作内存是隔离的。</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/jMM.jpg" alt=""></p>
<h3 id="内存间交互操作"><a href="#内存间交互操作" class="headerlink" title="内存间交互操作"></a>内存间交互操作</h3><p>JMM定义了8种操作来完成工作内存和主内存的交互，每一个操作都是原子的、不可再分的：</p>
<ul>
<li>lock（锁定）：作用于主内存的变量，它把一个变量标识为一个线程独占的状态</li>
<li>unlock（解锁）：作用于主内存的变量，它把一个处于锁定状态的变量释放出来，释放后的变量才可以被其他线程锁定</li>
<li>read（读取）：作用于主内存的变量，它把一个变量的值从主内存传送到线程中的工作内存，以便随后的load动作使用</li>
<li>load（载入）：作用于工作内存的变量，它把read操作从主内存中得到的变量值放入工作内存的变量副本中</li>
<li>use（使用）：作用于工作内存的变量，它把工作内存中一个变量的值传递给执行引擎</li>
<li>assign（赋值）：作用于工作内存的变量，它把一个从执行引擎接收到的值赋值给工作内存中的变量</li>
<li>store（存储）：作用于工作内存的变量，它把工作内存中的一个变量的值传送到主内存中，以便随后的write操作</li>
<li>write（写入）：作用于主内存的变量，它把store操作从工作内存中得到的变量的值写入主内存的变量中</li>
</ul>
<p><strong>Java内存模型还规定了执行上述8种基本操作时必须满足如下规则</strong></p>
<p>​     1、不允许read和load、store和write操作之一单独出现，以上两个操作必须按顺序执行，但没有保证必须连续执行，也就是说，read与load之间、store与write之间是可插入其他指令的。</p>
<p>​     2、不允许一个线程丢弃它的最近的assign操作，即变量在工作内存中改变了之后必须把该变化同步回主内存。</p>
<p>​     3、不允许一个线程无原因地（没有发生过任何assign操作）把数据从线程的工作内存同步回主内存中。</p>
<p>​     4、一个新的变量只能从主内存中“诞生”，不允许在工作内存中直接使用一个未被初始化（load或assign）的变量，换句话说就是对一个变量实施use和store操作之前，必须先执行过了assign和load操作。</p>
<p>​    5、一个变量在同一个时刻只允许一条线程对其执行lock操作，但lock操作可以被同一个条线程重复执行多次，多次执行lock后，只有执行相同次数的unlock操作，变量才会被解锁。</p>
<p>​    6、如果对一个变量执行lock操作，将会清空工作内存中此变量的值，在执行引擎使用这个变量前，需要重新执行load或assign操作初始化变量的值。</p>
<p>​    7、如果一个变量实现没有被lock操作锁定，则不允许对它执行unlock操作，也不允许去unlock一个被其他线程锁定的变量。</p>
<p>​    8、对一个变量执行unlock操作之前，必须先把此变量同步回主内存（执行store和write操作）。</p>
<h3 id="volatile型变量的特殊规则"><a href="#volatile型变量的特殊规则" class="headerlink" title="volatile型变量的特殊规则"></a>volatile型变量的特殊规则</h3><p>volatile保证了可见性和有序性，但不保证原子性。</p>
<p>####为什么不保证原子性？</p>
<p>因为修改一个volatile变量的值分为多步，先从主内存中read和load最新的值到工作内存，赋值修改后再store和write回去主内存。所以如果运算结果依赖当前值还是需通过加锁来保证原子性。</p>
<p>####volatile保证可见性、有序性？</p>
<p>通过禁止指令重排序来保证。</p>
<p>在修改完volatile变量的值后，会在后面多执行一条字节码指令，<code>lock addl $0x0,(%esp)</code>，这个操作相当于一个内存屏障（意味着之前的所有操作都已经执行完了，重排序的时候内存屏障之后的指令不能重排序到内存屏障之前）。lock的作用是使得本CPU的Cache写入了内存，该写入动作会导致其他CPU无效化其Cache，通过这样一个空操作，可让前面volatile变量的修改对其他CPU立即可见。</p>
<p>####JMM对volatile的特殊规则</p>
<ul>
<li>简单来说，要求工作内存使用Volatile变量之前必须先从主内存刷新最新的值</li>
<li>修改volatile变量的值需要立刻写回主内存</li>
<li>volatile修饰的变量不会被指令从排序优化。</li>
</ul>
<h3 id="sychronized的原子性、可见性、有序性是怎么实现的？"><a href="#sychronized的原子性、可见性、有序性是怎么实现的？" class="headerlink" title="sychronized的原子性、可见性、有序性是怎么实现的？"></a>sychronized的原子性、可见性、有序性是怎么实现的？</h3><ul>
<li>原子性：通过字节码指令<code>monitorenter</code>、<code>monitorexit</code>来保证，这两条指令隐式调用了lock和unlock操作，它们之间的代码块只能一次进入一个线程，故保证了原子性</li>
<li>可见性：syschronized的可见性是由”对一个变量执行unlock操作之前，必须先把此变量同步回主内存中“这条规则得到的。</li>
<li>有序性：一个变量在同一时刻只允许一条线程对其进行lock操作，持有同一个锁的两个同步块只能串行地进入。</li>
</ul>
<p>###先行发生原则（happen-before）</p>
<p>Java内存模型中定义的两项操作之间的偏序关系，如果说操作A先于操作B，其实就是说发送操作B之前，操作A产生的影响能被操作B观察到，影响包括了修改内存中共享变量的值、发送了信息、调用了方法等。</p>
<p>JMM有这些”天生的“先行发生原则：</p>
<p><strong>1、程序次序规则</strong>。<strong>在一个线程内，书写在前面的代码先行发生于后面的。确切地说应该是，按照程序的控制流顺序，因为存在一些分支结构。</strong></p>
<p><strong>2、Volatile变量规则</strong>。<strong>对一个volatile修饰的变量，对他的写操作先行发生于读操作。</strong></p>
<p><strong>3、线程启动规则。Thread对象的start()方法先行发生于此线程的每一个动作。</strong></p>
<p><strong>4、线程终止规则。线程的所有操作都先行发生于对此线程的终止检测。</strong></p>
<p><strong>5、线程中断规则。对线程interrupt()方法的调用先行发生于被中断线程的代码所检测到的中断事件。</strong></p>
<p><strong>6、对象终止规则。一个对象的初始化完成（构造函数之行结束）先行发生于发的finilize()方法的开始。</strong></p>
<p><strong>7、传递性</strong>。<strong>A先行发生B，B先行发生C，那么，A先行发生C。</strong></p>
<p><strong>8、管程锁定规则。一个usnlock操作先行发生于后面对同一个锁的lock操作。</strong></p>
<p>以上就是Java无需任何的同步手段就能成立的先行发生规则。其他情况下就没有顺序保障，虚拟机可以对它们随意地进行重排序。</p>
<p>-+**++++++++++++++++++++++++++</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/touxiang.png"
                alt="黄国航" />
            
              <p class="site-author-name" itemprop="name">黄国航</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Hghhhh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:huangguohang123@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄国航</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v="></script>



  


  




	





  





  




  
    <script id="cy_cmt_num" src="https://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cytyqQfqe"></script>
  









  





  

  

  

  
  

  

  

  

</body>
</html>
