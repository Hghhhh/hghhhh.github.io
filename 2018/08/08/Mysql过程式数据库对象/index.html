<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=">


  <link rel="mask-icon" href="/images/logo.svg?v=" color="#222">





  <meta name="keywords" content="mysql," />










<meta name="description" content="#一、存储过程 在MYSQL中，可以定义一段程序存放在数据库中，这样的程序称为存储过程。它是最重要的数据库对象之一。存储过程实质上就是一段代码，它可以由声明式SQL语句（如CREATE、UPDATE和SELECT等）和过程式SQL语句（如IF-THEN-ELSE)组成。存储过程可以由程序、触发器或者另一个存储过程来调用，从而激活它，实现代码段中的SQL语句。 使用存储过程的优点有： （1 )存储过">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="Mysql过程式数据库对象">
<meta property="og:url" content="http://yoursite.com/2018/08/08/Mysql过程式数据库对象/index.html">
<meta property="og:site_name" content="黄国航的博客">
<meta property="og:description" content="#一、存储过程 在MYSQL中，可以定义一段程序存放在数据库中，这样的程序称为存储过程。它是最重要的数据库对象之一。存储过程实质上就是一段代码，它可以由声明式SQL语句（如CREATE、UPDATE和SELECT等）和过程式SQL语句（如IF-THEN-ELSE)组成。存储过程可以由程序、触发器或者另一个存储过程来调用，从而激活它，实现代码段中的SQL语句。 使用存储过程的优点有： （1 )存储过">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2018-08-09T13:53:21.327Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mysql过程式数据库对象">
<meta name="twitter:description" content="#一、存储过程 在MYSQL中，可以定义一段程序存放在数据库中，这样的程序称为存储过程。它是最重要的数据库对象之一。存储过程实质上就是一段代码，它可以由声明式SQL语句（如CREATE、UPDATE和SELECT等）和过程式SQL语句（如IF-THEN-ELSE)组成。存储过程可以由程序、触发器或者另一个存储过程来调用，从而激活它，实现代码段中的SQL语句。 使用存储过程的优点有： （1 )存储过">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/08/08/Mysql过程式数据库对象/"/>





  <title>Mysql过程式数据库对象 | 黄国航的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黄国航的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/08/Mysql过程式数据库对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Mysql过程式数据库对象</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-08T09:30:28+08:00">
                2018-08-08
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2018/08/08/Mysql过程式数据库对象/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2018/08/08/Mysql过程式数据库对象/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>#一、存储过程</p>
<p>在MYSQL中，可以定义一段程序存放在数据库中，这样的程序称为存储过程。它是最重要的数据库对象之一。存储过程实质上就是一段代码，它可以由声明式SQL语句（如CREATE、UPDATE和SELECT等）和过程式SQL语句（如IF-THEN-ELSE)组成。存储过程可以由程序、触发器或者另一个存储过程来调用，从而激活它，实现代码段中的SQL语句。</p>
<p>使用存储过程的优点有：</p>
<p>（1 )存储过程在服务器端运行，执行速度快。</p>
<p>（2）存储过程执行一次后，其执行规划就驻留在高速缓冲存储器，在以后的操作中，只需从高速缓冲存储器中调用已编译好的二进制代码执行，从而提高了系统性能。</p>
<p>（3）确保数据库安全。使用存储过程可以完成所有数据库操作，并可通过编程方式控制上述操作对数据库信息访问的权限。</p>
<a id="more"></a>
<h2 id="1-创建存储过程"><a href="#1-创建存储过程" class="headerlink" title="1.创建存储过程"></a>1.创建存储过程</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> 存储过程名 ([参数 ...])  [特征...] 主体</span><br></pre></td></tr></table></figure>
<h3 id="（1）参数"><a href="#（1）参数" class="headerlink" title="（1）参数"></a>（1）参数</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[IN|OUT|INOUT]  参数名 参数类型</span><br></pre></td></tr></table></figure>
<p>MYSQL存储过程支持三种类型的参数：输入参数、输出参数和输入/输出参数，关键字分别是IN、OUT、INOUT。输入参数使数据可以传递给一个存储过程。当需要返回一个答案或结果时，存储过程使用输出参数。输入/输出参数既可以充当输入参数也可以充当输出参数。</p>
<h3 id="（2）特征"><a href="#（2）特征" class="headerlink" title="（2）特征"></a>（2）特征</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE  SQL</span><br><span class="line"></span><br><span class="line">|[NOT] DETERMINISTIC</span><br><span class="line"></span><br><span class="line">| &#123;CONTAINS SQL|NO SQL|READS SQL DATA | MODIFIES SQL DATA&#125;</span><br><span class="line"></span><br><span class="line">|SQL SECURITY|&#123;DEFINER | INVOKER&#125;</span><br><span class="line"></span><br><span class="line">]<span class="keyword">COMMENT</span>  <span class="string">'string'</span></span><br></pre></td></tr></table></figure>
<p>其中：</p>
<p>LANGUAGE SQL—表明编写这个存储过程的语言为SQL语言，从目前情况来讲，MYSQL存储过程还不能用外部编程语言来编写，也就是说，这个选项可以不指定，将来会对其扩展，最有可能第一个得到支持的语言是PHP.</p>
<p>DETERMINISTIC—设置为DETERMINISTIC表示存储过程对同样的输人参数产生相同的结果，设置为NOT DETERMINISTIC则表示会产生不确定的结果。默认为NOT DETERMINISTIC.</p>
<p>CONTAINS SQL—表示存储过程不包含读或写数据的语句。NO SQL表示存储过程不包含SQL语句。READS SQL DATA表示存储过程包含读数据的语句，但不包含写数据的语句。MODIFIES SQL DATA表示存储过程包含写数据的语句。如果这些特征没有明确给定，则默认的是CONTAINS SQL。</p>
<p>SQL SECURITY—SQL SECURITY特征可以用来指定存储过程使用创建该存储过程的用户（DFINER）的许可来执行，还是使用调用者（INVOKER）的许可来执行。默认值是DEFINER。</p>
<p>COMMENT ‘string’—对存储过程的描述，string为描述内容。这个信息可以用SHOW CREATE PROCEDURE语句来显示。</p>
<p>###（3）主体</p>
<p>存储过程主体称为存储过程体。里面包含了在过程调用的时候必须执行的语句，这个部分总是以<code>BEGIN</code>开始，以<code>END</code>结束。当然，当存储过程体中只有一个SQL语句时可以省略BEGIN-END标志。</p>
<p>在MYSQL中，服务器处理语句的时候是以分号为结束标志的。但是在创建存储过程的时候，存储过程体中可能包含多个分号，故使用“DELIMITER”结束符号将MYSQL语句的结束标记修改为其他符号。最后再使用<code>delimiter ；</code>恢复以分号为结束符号。</p>
<p>【例1】：用存储过程实现删除一个特定学生的信息。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> delete_student(<span class="keyword">IN</span> xh <span class="built_in">CHAR</span>)</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">DELETE</span> <span class="keyword">FROM</span> tb_student <span class="keyword">WHERE</span> <span class="keyword">sid</span> = xh;</span><br><span class="line"><span class="keyword">END</span> $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h2 id="2-存储过程体"><a href="#2-存储过程体" class="headerlink" title="2.存储过程体"></a>2.存储过程体</h2><p>在存储过程体中，可以使用所有的SQL语句类型，包括所有的DLL，DCL和DML语句。当然，过程时语句也是允许的。其中也包括变量的定义和赋值。</p>
<h3 id="（1）局部变量"><a href="#（1）局部变量" class="headerlink" title="（1）局部变量"></a>（1）局部变量</h3><p>在存储过程中可以声明局部变量，用来存放临时结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 变量名 ... 类型 [默认值]</span><br></pre></td></tr></table></figure>
<p>说明：声明的局部变量只在BEGIN-END里面有效，如在变量名前面加<code>@</code>，则为用户变量，用户变量可存在于整个会话中。</p>
<h3 id="（2）SELECT…INTO语句"><a href="#（2）SELECT…INTO语句" class="headerlink" title="（2）SELECT…INTO语句"></a>（2）SELECT…INTO语句</h3><p>使用这个语句可以把选定的列值直接储存到变量中，因此，返回的结果只能有一行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 列名[,...] <span class="keyword">INTO</span> 变量名[,...] <span class="keyword">from</span> ...</span><br></pre></td></tr></table></figure>
<h3 id="（3）流程控制语句"><a href="#（3）流程控制语句" class="headerlink" title="（3）流程控制语句"></a>（3）流程控制语句</h3><p>在MYSQL中，常见的过程式SQL语句可以用在一个存储过程体中。例如IF语句、CASE语句、LOOP语句、WHILE语句、ITERATE语句和LEAVE语句</p>
<h4 id="1）IF语句"><a href="#1）IF语句" class="headerlink" title="1）IF语句"></a>1）IF语句</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF 条件 THEN 语句</span><br><span class="line">[ELSEIF 条件 THEN 语句] ...</span><br><span class="line">[ELSE 语句]</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">IF</span></span><br></pre></td></tr></table></figure>
<p>【例2】：比较传入的a，b两个数的大小，并将结果输出给c</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> compair(<span class="keyword">IN</span> a <span class="built_in">INTEGER</span>,<span class="keyword">IN</span> b <span class="built_in">INTEGER</span>,<span class="keyword">OUT</span> c <span class="built_in">CHAR</span>(<span class="number">2</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">IF</span> a&gt;b <span class="keyword">THEN</span> <span class="keyword">SET</span> c=<span class="string">'大于'</span>;</span><br><span class="line">	ELSEIF a=b THEN <span class="keyword">SET</span> c=<span class="string">'等于'</span>;</span><br><span class="line">	ELSE <span class="keyword">SET</span> c=<span class="string">'小于'</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line"><span class="keyword">END</span> $$</span><br><span class="line">DELIMITER ;</span><br><span class="line">//调用存储过程</span><br><span class="line"><span class="keyword">CALL</span> compair(<span class="number">10</span>,<span class="number">100</span>,@<span class="keyword">result</span>);</span><br><span class="line"><span class="keyword">SELECT</span> @<span class="keyword">result</span></span><br></pre></td></tr></table></figure>
<p>####2）CASE语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CASE case_value</span><br><span class="line">	WHEN value_a THEN 语句;</span><br><span class="line">	[WHEN value_b THEN 语句] ...</span><br><span class="line">    [ELSE 语句]</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span></span><br></pre></td></tr></table></figure>
<p>或</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CASE </span><br><span class="line">	WHEN 条件 THEN 语句</span><br><span class="line">	[WHEN 条件 THEN 语句]...</span><br><span class="line">	[ELSE 语句]</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">CASE</span></span><br></pre></td></tr></table></figure>
<p>【例3】：创建一个存储过程，针对参数的不同，返回不同的结果。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> getSex(<span class="keyword">IN</span> <span class="keyword">str</span> <span class="built_in">VARCHAR</span>(<span class="number">4</span>),<span class="keyword">OUT</span> sex <span class="built_in">VARCHAR</span>(<span class="number">4</span>))</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">	<span class="keyword">CASE</span> <span class="keyword">STR</span></span><br><span class="line">		<span class="keyword">WHEN</span> <span class="string">'m'</span> <span class="keyword">THEN</span> <span class="keyword">SET</span> sex=<span class="string">'男'</span>;</span><br><span class="line">		WHEN 'f' THEN <span class="keyword">SET</span> sex=<span class="string">'女'</span>;</span><br><span class="line">		ELSE <span class="keyword">SET</span> sex=<span class="string">'无'</span>;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">CASE</span>;</span><br><span class="line"><span class="keyword">END</span> $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<h4 id="3）循环语句"><a href="#3）循环语句" class="headerlink" title="3）循环语句"></a>3）循环语句</h4><p>MYSQL支持3条循环语句：WHILE、REPEAT、LOOP语句。</p>
<h5 id="WHILE语句"><a href="#WHILE语句" class="headerlink" title="WHILE语句"></a>WHILE语句</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[begin_label:]</span><br><span class="line">WHILE 条件 <span class="keyword">DO</span></span><br><span class="line">	语句</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">WHILE</span> [end_label]</span><br><span class="line">[end_label]</span><br></pre></td></tr></table></figure>
<p>说明：begin_label和end_label为WHILE语句的标注。除非begin_label存在，否则end_label不能被给出，并且两者的名字必须相同。</p>
<h5 id="REPEAT语句"><a href="#REPEAT语句" class="headerlink" title="REPEAT语句"></a>REPEAT语句</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[begin_label:]</span><br><span class="line">REPEAT</span><br><span class="line">	语句</span><br><span class="line">	UNTIL 条件</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">REPEAT</span></span><br><span class="line">[end_label]</span><br></pre></td></tr></table></figure>
<p>#####LOOP语句</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[begin_label:]</span><br><span class="line">LOOP</span><br><span class="line">   语句</span><br><span class="line"><span class="keyword">END</span> <span class="keyword">LOOP</span></span><br><span class="line">[end_label]</span><br></pre></td></tr></table></figure>
<p>说明：LOOP允许某特定语句或语句群的重复执行，实现一个简单的循环构造。在循环内的语句一直重复直至循环被退出，退出时通常伴随着一个LEAVE语句。</p>
<p>【例4】：创建一个带LOOP语句的存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">PROCEDURE</span> myLoop()</span><br><span class="line"><span class="keyword">BEGIN</span> </span><br><span class="line">    <span class="keyword">SET</span> @a = <span class="number">10</span>;</span><br><span class="line">    lavel:</span><br><span class="line">    LOOP </span><br><span class="line">	<span class="keyword">SET</span> @a=a<span class="number">-1</span>;</span><br><span class="line">	IF a&lt;0 THEN </span><br><span class="line">	    LEAVE lavel;</span><br><span class="line">	<span class="keyword">END</span> <span class="keyword">IF</span>;</span><br><span class="line">    <span class="keyword">END</span> <span class="keyword">LOOP</span> </span><br><span class="line">    lavel;</span><br><span class="line">    <span class="keyword">END</span> $$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>
<p>另外，循环语句中还有一个ITERATE语句，它只可以出现在LOOP、REPEAT和WHILE语句内，意为“再次循环”。它的格式为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label</span><br></pre></td></tr></table></figure>
<p>leave语句为离开一个循环，而ITERATE为重新开始一个循环。</p>
<p>###（4）处理程序和条件</p>
<p>在存储过程中处理SQL语句可能导致一条错误消息。例如，向一个表中插入新的行而主键值已经存在，这条INSERT语句会导致一个出错消息，并且MYSQL、即停上对存储过程的处理。每一个错误消息都有一个唯一代码和一个SQLSTATE代码。例如，SQLSTATE23000属于如下的出错代码：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Error1022，"Can'twrite;duplicatekeyintable"</span><br><span class="line"></span><br><span class="line">Error1048，"Columncannotbenull"</span><br><span class="line"></span><br><span class="line">Error1052，"Columnisambiguous"</span><br><span class="line"></span><br><span class="line">Error1062，"Duplicateentryforkey"</span><br></pre></td></tr></table></figure>
<p>MYSQL手册的“错误消息和代码”一章中列出了所有的出错消息及它们各自的代码。为了防止MySQL在一条错误消息产生时就停止处理，需要使用到<code>DECLARE HANDLER</code>语句。</p>
<p>DECLARE HANDER语句为错误代码声明了一个所谓的处理程序，它指明：对一条SQL语句的处理如果导致一条错误消息，将会发生什么。</p>
<p>DECLARE HANDLER语法格式为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span>  处理程序的类型  <span class="keyword">HANDLER</span> <span class="keyword">FOR</span> condition_value[，…〕 存储过程语句</span><br></pre></td></tr></table></figure>
<p>#####1）处理程序的类型</p>
<p>处理程序的类型主要有三种：CONTINUE、EXIT和UNDOO。对CONTINUE处理程</p>
<p>序，MYSQL不中断存储过程的处理。对于EXIT处理程序，当前BEGIN…END复合语句</p>
<p>的执行被终止。UNDO处理程序类型语句暂时还不被支持。</p>
<p>#####2）condition_value</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">condition_value：</span><br><span class="line"></span><br><span class="line">SOLSTATE [VALUE] sqlstate_value</span><br><span class="line"></span><br><span class="line">|condition_name</span><br><span class="line"></span><br><span class="line">|SQLWAIRNING</span><br><span class="line"></span><br><span class="line">|NOT_FOUND</span><br><span class="line"></span><br><span class="line">|SQLEXCEPTION</span><br><span class="line"></span><br><span class="line">|mysql_error_code</span><br></pre></td></tr></table></figure>
<p> 说明：</p>
<p>condition_name是处理条件的名称，接下来会介绍。</p>
<p>SQLWARNING是对所有以01开头的SQLSTATE代码的速记。NOT FOUND是对</p>
<p>所有以02开头的SQLSTATE代码的速记。SQLEXCEPTION是对所有没有被</p>
<p>SQL-WARNING或NOTFOUND捕获的SQLSTATE代码的速记。当用户不想为每个可</p>
<p>能的出错消息都定义一个处理程序时可以使用以上三种形式。</p>
<p>mysql_error_code是具体的SQLSTATE代码。除了SQLSTATE值外，MySQL错误</p>
<p>代码也被支持，表示的形式为：ERROR=’xxxx’。</p>
<p>【例5】：创建一个存储过程，向xs表插入一行数据（’081101’, ‘王民’, ‘计算机’, 1, ‘1994-02-10’, 50 , NULL, NULL），已知学号081101在XS表中已存在。如果出现错误，程序继续进行。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> xscj;</span><br><span class="line"></span><br><span class="line">delimiter $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> my_insert ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> continue <span class="keyword">handler</span> <span class="keyword">for</span> <span class="keyword">sqlstate</span> <span class="string">'23000'</span> <span class="keyword">set</span> @x2=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> @x=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">insert</span> <span class="keyword">into</span> xs <span class="keyword">values</span>(<span class="string">'081101'</span>, <span class="string">'王民'</span>, <span class="string">'计算机'</span>, <span class="number">1</span>, <span class="string">'1994-02-10'</span>, <span class="number">50</span> , <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> @x=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<p>为了提高可读性，可以使用DECLARE CONDITION语句为一个SQLSTATE或出错代码定义一个名字，并且可以在处理程序中使用这个名字。</p>
<p>DECLARE CONDITION语法格式为：</p>
<p>DECLARE condition_name CONDITION FOR condition_value</p>
<p>其中，condition_name是处理条件的名称，condition_value为要定义别名的SQLSTATE或出错代码。同DECLARE HANDLER。</p>
<p>【例6】:修改前例中的存储过程，将SQLSTATE ‘23000’ 定义成NON_UNIQUE，并在处理程序中使用这个名称，程序片段为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span> </span><br><span class="line"></span><br><span class="line">    <span class="keyword">declare</span> non_unique condition <span class="keyword">for</span> <span class="keyword">sqlstate</span> <span class="string">'23000'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">declare</span> continue <span class="keyword">handler</span> <span class="keyword">for</span> non_unique <span class="keyword">set</span> @x2=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> @x=<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">insert</span> <span class="keyword">into</span> xs <span class="keyword">values</span>(<span class="string">'081101'</span>, <span class="string">'王民'</span>, <span class="string">'计算机'</span>, <span class="number">1</span>, <span class="string">'1994-02-10'</span>, <span class="number">50</span> , <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> @x=<span class="number">3</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
<p>###（5）游标</p>
<p>一条SELECT…INTO语句返回的是带有值的一行，这样可以把数据读取到存储过程中。但是常规的SELECT语句返回的是多行数据，如果要处理它需要引入游标这一MYSQL支持简单的游标。游标一定要在存储过程或函数中使用，不能单独在查询中使用。使用一个游标需要用到4条特殊语句：DECLARE CURSOR（声明游标）OPENCURSOR(打开游标）、FETCH CURSOR（读取游标）和CLOSE CURSOR(关闭游标）。</p>
<h5 id="1）声明游标"><a href="#1）声明游标" class="headerlink" title="1）声明游标"></a>1）声明游标</h5><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> 游标名 <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">select</span>语句</span><br></pre></td></tr></table></figure>
<p>说明：这个语句声明一个游标，也可以在存储过程中定义多个游标。但是一个块中的每一个游标必须有唯一的名字。</p>
<p>下面的定义符合一个游标声明：</p>
<p>【例7】：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> xs_cur1 <span class="keyword">cursor</span>  <span class="keyword">for</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">select</span> 学号,姓名,性别,出生日期,总学分</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> xs</span><br><span class="line"></span><br><span class="line">        <span class="keyword">where</span> 专业名 = <span class="string">'计算机'</span>;</span><br></pre></td></tr></table></figure>
<h5 id="2）打开游标"><a href="#2）打开游标" class="headerlink" title="2）打开游标"></a>2）打开游标</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPEN 游标名</span><br></pre></td></tr></table></figure>
<h5 id="3）读取数据"><a href="#3）读取数据" class="headerlink" title="3）读取数据"></a>3）读取数据</h5><p>游标打开后，就可以使用FETCH…INTO语句从中读取数据。</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FETCH游标名INTO 变量名 ...</span><br></pre></td></tr></table></figure>
<p>#####4）关闭游标</p>
<p>游标使用完以后，要及时关闭。关闭游标使用CLOSE语句，格式为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSE 游标名</span><br></pre></td></tr></table></figure>
<p>语句参数的含义与OPEN语句中相同。例如：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSE xs_cur2</span><br></pre></td></tr></table></figure>
<p>将关闭游标xs_cur2。</p>
<p>【例8】：</p>
<p>创建一个存储过程，计算xs表中行的数目。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> <span class="keyword">compute</span> (<span class="keyword">out</span> <span class="built_in">number</span> <span class="built_in">integer</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> xh <span class="built_in">char</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> <span class="keyword">found</span> <span class="built_in">boolean</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> number_xs <span class="keyword">cursor</span> <span class="keyword">for</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> 学号 <span class="keyword">from</span> xs;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> continue <span class="keyword">handler</span> <span class="keyword">for</span> <span class="keyword">not</span> <span class="keyword">found</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="keyword">found</span>=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="built_in">number</span>=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  open number_xs;</span><br><span class="line"></span><br><span class="line">  fetch number_xs into xh;</span><br><span class="line"></span><br><span class="line">  while found <span class="keyword">do</span> </span><br><span class="line"></span><br><span class="line">  <span class="keyword">set</span> <span class="built_in">number</span>=<span class="built_in">number</span>+<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  fetch number_xs into xh;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">while</span>;</span><br><span class="line"></span><br><span class="line">  close number_xs;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"></span><br><span class="line"><span class="keyword">call</span> <span class="keyword">compute</span>(@<span class="keyword">num</span>);</span><br><span class="line"><span class="keyword">select</span> @<span class="keyword">num</span>;</span><br></pre></td></tr></table></figure>
<h2 id="3-存储过程的调用、删除和修改"><a href="#3-存储过程的调用、删除和修改" class="headerlink" title="3.存储过程的调用、删除和修改"></a>3.存储过程的调用、删除和修改</h2><p>###（1）存储过程的调用</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CALL</span> 存储过程名([参数 ... ])</span><br></pre></td></tr></table></figure>
<h3 id="（2）存储过程的删除"><a href="#（2）存储过程的删除" class="headerlink" title="（2）存储过程的删除"></a>（2）存储过程的删除</h3><p>存储过程创建后需要删除时使用DROP PROCEDURE语句。在此之前，必须确认该存储过程没有任何依赖关系，否则会导致其他与之关联的存储过程无法运行。</p>
<p>语法格式为： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">PROCEDURE</span>  [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] 存储过程名</span><br></pre></td></tr></table></figure>
<p>###（3）修改存储过程</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ALTER</span> <span class="keyword">PROCEDURE</span>  存储过程名 [特征 ...]</span><br></pre></td></tr></table></figure>
<p>特征=：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</span><br><span class="line"></span><br><span class="line">| SQL SECURITY &#123; DEFINER | INVOKER &#125;</span><br><span class="line"></span><br><span class="line">| <span class="keyword">COMMENT</span> <span class="string">'string'</span></span><br></pre></td></tr></table></figure>
<h1 id="二、存储函数"><a href="#二、存储函数" class="headerlink" title="二、存储函数"></a>二、存储函数</h1><p>存储函数和存储过程都是由SQL和过程式语句组成的代码片断，并且可以从应用程序和SQL中调用。然而，它们也有一些区别：</p>
<p>（1）存储函数不能拥有输出参数，因为存储函数本身就是输出参数；</p>
<p>（2）不能用CALL语句来调用存储函数；</p>
<p>（3）存储函数必须包含一条RETURN语句，而这条特殊的SQL语句不允许包含于存储过程中。</p>
<h2 id="1-创建存储函数"><a href="#1-创建存储函数" class="headerlink" title="1.创建存储函数"></a>1.创建存储函数</h2><p>CREATE FUNCTION语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> 存储过程名 ([参数 ... ])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">RETURNS</span> <span class="keyword">type</span></span><br><span class="line"></span><br><span class="line">    [特征 ...]    主体</span><br></pre></td></tr></table></figure>
<p>【例9】：创建一个存储函数来删除xs_kc表中有，但xs表中不存在的学号。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> delete_stu(xh <span class="built_in">char</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">returns</span> <span class="built_in">boolean</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">declare</span> stu <span class="built_in">char</span>(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">select</span> 姓名 <span class="keyword">into</span> stu <span class="keyword">from</span> xs <span class="keyword">where</span> 学号=xh;</span><br><span class="line"></span><br><span class="line">  if stu is null then</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> <span class="keyword">from</span> xs_kc <span class="keyword">where</span> 学号=xh; </span><br><span class="line"></span><br><span class="line">  return true;</span><br><span class="line"></span><br><span class="line">  else </span><br><span class="line"></span><br><span class="line">  return false;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line"></span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<h2 id="2-存储函数的调用"><a href="#2-存储函数的调用" class="headerlink" title="2.存储函数的调用"></a>2.存储函数的调用</h2><p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> 存储函数名 ([参数[,...]])</span><br></pre></td></tr></table></figure>
<h2 id="3-存储函数的删除"><a href="#3-存储函数的删除" class="headerlink" title="3.存储函数的删除"></a>3.存储函数的删除</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">FUNCTION</span> [<span class="keyword">IF</span> <span class="keyword">EXISTS</span>] 存储过程名</span><br></pre></td></tr></table></figure>
<h1 id="三、触发器"><a href="#三、触发器" class="headerlink" title="三、触发器"></a>三、触发器</h1><p>##1.创建触发器</p>
<p>创建触发器使用CREATE TRIGGER语句  ，要查看数据库中有哪些触发器使用SHOW TRIGGERS命令。</p>
<p>CREATE TRIGGER语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> 触发器名  触发时刻  触发事件</span><br><span class="line">    <span class="keyword">ON</span> 表名 <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span>  触发器动作</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>触发器名称在当前数据库中必须唯一。</li>
<li>触发时刻，有两个选项：AFTER和BEFORE，以表示触发器是在激活它的语句之前或之后触发。</li>
<li>触发事件：指明了激活触发程序的语句的类型。</li>
<li>表名：表示在该表上发生触发事件才会激活触发器。</li>
<li>FOR EACH ROW：这个声明用来指定，对于受触发事件影响的每一行，都要激活触发器的动作。</li>
<li>触发器动作：包含触发器激活时将要执行的语句。</li>
</ul>
<p>【例10】：创建一个表table1，其中只有一列a。在表上创建一个触发器，每次插入操作时，将用户变量str的值设为“trigger is working”。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table table1(a integer);</span><br><span class="line"></span><br><span class="line">create trigger table1_insert after insert</span><br><span class="line"></span><br><span class="line">  on table1 for each row</span><br><span class="line"></span><br><span class="line">  set @str= &apos; trigger is working &apos;;</span><br></pre></td></tr></table></figure>
<p>向table1中插入一行数据：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table1 <span class="keyword">values</span>(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<p>查看str的值： </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> @<span class="keyword">str</span>;</span><br></pre></td></tr></table></figure>
<p>###（1）触发器中关联表中的列</p>
<p>在MySQL触发器中的SQL语句可以关联表中的任意列。但不能直接使用列的名称去标志，那会使系统混淆，因为激活触发器的语句可能已经修改、删除或添加了新的列名，而列的旧名同时存在。因此必须用这样的语法来标志：“NEW.column_name”或者“OLD.column_name”。NEW.column_name用来引用新行的一列，OLD.column_name用来引用更新或删除它之前的已有行的一列。</p>
<p>对于INSERT语句，只有NEW是合法的；对于DELETE语句，只有OLD才合法；而UPDATE语句可以与NEW或OLD同时使用。</p>
<p>【例11】：</p>
<p>创建一个触发器，当删除表xs中某个学生的信息时，同时将xs_kc表中与该学生有关的数据全部删除。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> xs_delete <span class="keyword">after</span> <span class="keyword">delete</span></span><br><span class="line">  <span class="keyword">on</span> xs <span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">delete</span> <span class="keyword">from</span> xs_kc <span class="keyword">where</span> 学号=old.学号;</span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<p>###（2）触发器中调用存储过程</p>
<p>在触发器中还可以调用存储过程。</p>
<p>【例12】：假设xscj数据库中有一个与xs表结构完全一样的表student，创建一个触发器，在xs表中添加数据的时候，调用存储过程，将student表中的数据与xs表同步。</p>
<p>首先，定义存储过程：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> changes()</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">replace</span> <span class="keyword">into</span> student <span class="keyword">select</span> * <span class="keyword">from</span> xs;</span><br><span class="line"><span class="keyword">end</span>$$</span><br><span class="line">delimiter;</span><br></pre></td></tr></table></figure>
<p>接着创建触发器：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">trigger</span> student_change <span class="keyword">after</span> <span class="keyword">insert</span></span><br><span class="line">  <span class="keyword">on</span> xs <span class="keyword">for</span> <span class="keyword">each</span> <span class="keyword">row</span></span><br><span class="line">    <span class="keyword">call</span> changes();</span><br></pre></td></tr></table></figure>
<p>##2.触发器删除</p>
<p>和其他数据库对象一样，使用DROP语句即可将触发器从数据库中删除。</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> [schema_name.]trigger_name</span><br></pre></td></tr></table></figure>
<h1 id="四、事件"><a href="#四、事件" class="headerlink" title="四、事件"></a>四、事件</h1><p>事件的主要作用如下：</p>
<ul>
<li>关闭账户；</li>
<li>打开或关闭数据库指示器；</li>
<li>使数据库中的数据在某个间隔后刷新；</li>
<li>执行对进入数据的复杂的检查工作。</li>
</ul>
<h2 id="创建事件"><a href="#创建事件" class="headerlink" title="创建事件"></a>创建事件</h2><p>创建事件可以使用CREATE EVENT语句。</p>
<p>语法格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EVENT</span> [<span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span>] 事件名    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">ON</span> SCHEDULE schedule</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">ON</span> COMPLETION [<span class="keyword">NOT</span>] <span class="keyword">PRESERVE</span>]</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">ENABLE</span> | <span class="keyword">DISABLE</span> | <span class="keyword">DISABLE</span> <span class="keyword">ON</span> <span class="keyword">SLAVE</span>]</span><br><span class="line"></span><br><span class="line">    [<span class="keyword">COMMENT</span> <span class="string">'comment'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">DO</span> <span class="keyword">sql</span>语句;</span><br></pre></td></tr></table></figure>
<p>schedule=：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AT timestamp [+ INTERVAL interval] | EVERY interval </span><br><span class="line">[STARTS timestamp [+ INTERVAL interval]] </span><br><span class="line">[ENDS timestamp [+ INTERVAL interval]]</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">interval:</span><br><span class="line">count &#123;  YEAR | QUARTER | MONTH | DAY | HOUR | MINUTE |</span><br><span class="line"></span><br><span class="line">          WEEK | SECOND | YEAR_MONTH | DAY_HOUR | DAY_MINUTE |</span><br><span class="line"></span><br><span class="line">          DAY_SECOND | HOUR_MINUTE | HOUR_SECOND | MINUTE_SECOND&#125;</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li>schedule：时间调度，表示事件何时发生或者每隔多久发生一次。</li>
<li>sql语句：包含事件启动时执行的代码。</li>
<li>事件的属性：对于每一个事件都可以定义几个属性。</li>
</ul>
<p>MySQL事件调度器负责调用事件。这个模块是MySQL数据库服务器的一部分。它不断地监视一个事件是否需要调用。要创建事件，必须打开调度器。可以使用系统变量EVENT_SCHEDULER来打开事件调度器，TRUE为打开，FALSE为关闭：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SET</span> <span class="keyword">GLOBAL</span> EVENT_SCHEDULER = <span class="literal">TRUE</span>;</span><br></pre></td></tr></table></figure>
<p>【例13】:创建一个立即启动的事件。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> xscj</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">event</span> direct</span><br><span class="line"></span><br><span class="line">   <span class="keyword">on</span> schedule  <span class="keyword">at</span> <span class="keyword">now</span>()</span><br><span class="line"></span><br><span class="line">   <span class="keyword">do</span> <span class="keyword">insert</span> <span class="keyword">into</span> xs <span class="keyword">values</span>(<span class="string">'091103'</span>, <span class="string">'张建'</span>, <span class="string">'软件工程'</span>, <span class="number">1</span>, <span class="string">'1994-06-05'</span>, </span><br><span class="line"></span><br><span class="line">  <span class="number">50</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
<p>【例14】:创建一个事件，它每个月启动一次，开始于下一个月并且在2014年的12月31日结束。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">event</span> startmonth</span><br><span class="line">  <span class="keyword">on</span> schedule  every <span class="number">1</span> <span class="keyword">month</span></span><br><span class="line">  starts <span class="keyword">curdate</span>()+<span class="built_in">interval</span> <span class="number">1</span> <span class="keyword">month</span></span><br><span class="line">  ends <span class="string">'2014-12-31'</span></span><br><span class="line">  <span class="keyword">do</span> </span><br><span class="line">  <span class="keyword">begin</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">year</span>(<span class="keyword">curdate</span>())&lt;<span class="number">2014</span>  <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">insert</span> <span class="keyword">into</span> xs <span class="keyword">values</span>(<span class="string">'091105'</span>, <span class="string">'王建'</span>, <span class="string">'软件工程'</span>, <span class="number">1</span>, <span class="string">'1994-03-16'</span>,<span class="number">48</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">if</span>;</span><br><span class="line">  <span class="keyword">end</span>$$</span><br><span class="line">delimiter ;</span><br></pre></td></tr></table></figure>
<p>​                                                        参考：《MySQL教程》 -邓阿奇主编</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/mysql/" rel="tag"># mysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/06/Mysql索引/" rel="next" title="Mysql索引">
                <i class="fa fa-chevron-left"></i> Mysql索引
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/26/微信小程序支付/" rel="prev" title="微信小程序支付">
                微信小程序支付 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/touxiang.png"
                alt="黄国航" />
            
              <p class="site-author-name" itemprop="name">黄国航</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Hghhhh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:huangguohang123@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-创建存储过程"><span class="nav-text">1.创建存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#（1）参数"><span class="nav-text">（1）参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#（2）特征"><span class="nav-text">（2）特征</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-存储过程体"><span class="nav-text">2.存储过程体</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#（1）局部变量"><span class="nav-text">（1）局部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#（2）SELECT…INTO语句"><span class="nav-text">（2）SELECT…INTO语句</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#（3）流程控制语句"><span class="nav-text">（3）流程控制语句</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1）IF语句"><span class="nav-text">1）IF语句</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3）循环语句"><span class="nav-text">3）循环语句</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#WHILE语句"><span class="nav-text">WHILE语句</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#REPEAT语句"><span class="nav-text">REPEAT语句</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1）声明游标"><span class="nav-text">1）声明游标</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2）打开游标"><span class="nav-text">2）打开游标</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3）读取数据"><span class="nav-text">3）读取数据</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-存储过程的调用、删除和修改"><span class="nav-text">3.存储过程的调用、删除和修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#（2）存储过程的删除"><span class="nav-text">（2）存储过程的删除</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、存储函数"><span class="nav-text">二、存储函数</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-创建存储函数"><span class="nav-text">1.创建存储函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-存储函数的调用"><span class="nav-text">2.存储函数的调用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-存储函数的删除"><span class="nav-text">3.存储函数的删除</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、触发器"><span class="nav-text">三、触发器</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、事件"><span class="nav-text">四、事件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#创建事件"><span class="nav-text">创建事件</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄国航</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v="></script>
<script type="text/javascript" src="/js/src/post-details.js?v="></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v="></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cytyqQfqe';
      var conf = '6a41e203093499026ca336cb276dfdc4';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  









  





  

  

  

  
  

  

  

  

</body>
</html>
