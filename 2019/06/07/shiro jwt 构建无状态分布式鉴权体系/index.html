<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=">


  <link rel="mask-icon" href="/images/logo.svg?v=" color="#222">





  <meta name="keywords" content="Shiro," />










<meta name="description" content="##概括  在分布式系统中，没法将认证、授权信息保存在session或本地内存中，这里使用JWT Token的方式来保存认证信息。需要提供一个令牌签发服务来进行Tokean的签发，每次请求的时候带上该Token，每个被调用的服务都需要有对该Token进行鉴权的功能。 JWTJWT(json web token)是可在网络上传输的用于声明某种主张的令牌（token），以JSON 对象为载体的轻量级开">
<meta name="keywords" content="Shiro">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro jwt 构建无状态分布式鉴权体系">
<meta property="og:url" content="http://yoursite.com/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/index.html">
<meta property="og:site_name" content="黄国航的博客">
<meta property="og:description" content="##概括  在分布式系统中，没法将认证、授权信息保存在session或本地内存中，这里使用JWT Token的方式来保存认证信息。需要提供一个令牌签发服务来进行Tokean的签发，每次请求的时候带上该Token，每个被调用的服务都需要有对该Token进行鉴权的功能。 JWTJWT(json web token)是可在网络上传输的用于声明某种主张的令牌（token），以JSON 对象为载体的轻量级开">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/JWI%20Token%E7%AD%BE%E5%8F%91%E5%92%8C%E9%89%B4%E6%9D%83.png">
<meta property="og:updated_time" content="2019-06-07T14:27:02.729Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Shiro jwt 构建无状态分布式鉴权体系">
<meta name="twitter:description" content="##概括  在分布式系统中，没法将认证、授权信息保存在session或本地内存中，这里使用JWT Token的方式来保存认证信息。需要提供一个令牌签发服务来进行Tokean的签发，每次请求的时候带上该Token，每个被调用的服务都需要有对该Token进行鉴权的功能。 JWTJWT(json web token)是可在网络上传输的用于声明某种主张的令牌（token），以JSON 对象为载体的轻量级开">
<meta name="twitter:image" content="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/JWI%20Token%E7%AD%BE%E5%8F%91%E5%92%8C%E9%89%B4%E6%9D%83.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/"/>





  <title>Shiro jwt 构建无状态分布式鉴权体系 | 黄国航的博客</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">黄国航的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="黄国航">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/touxiang.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黄国航的博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Shiro jwt 构建无状态分布式鉴权体系</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-07T19:57:22+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-comment-o"></i>
              </span>
              
                <a href="/2019/06/07/shiro jwt 构建无状态分布式鉴权体系/#SOHUCS" itemprop="discussionUrl">
                  <span id="changyan_count_unit" class="post-comments-count hc-comment-count" data-xid="2019/06/07/shiro jwt 构建无状态分布式鉴权体系/" itemprop="commentsCount"></span>
                </a>
              
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>##概括</p>
<p><img src="https://3116004636-1256103796.cos.ap-guangzhou.myqcloud.com/JWI%20Token%E7%AD%BE%E5%8F%91%E5%92%8C%E9%89%B4%E6%9D%83.png" alt="JWT鉴权场景"></p>
<p>在分布式系统中，没法将认证、授权信息保存在session或本地内存中，这里使用JWT Token的方式来保存认证信息。需要提供一个令牌签发服务来进行Tokean的签发，每次请求的时候带上该Token，每个被调用的服务都需要有对该Token进行鉴权的功能。</p>
<h3 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h3><p>JWT(json web token)是可在网络上传输的用于声明某种主张的令牌（token），以JSON 对象为载体的轻量级开放标准（RFC 7519）。</p>
<p>一个JWT令牌的定义包含头信息、荷载信息、签名信息三个部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Header//头信息</span><br><span class="line">&#123;</span><br><span class="line">    &quot;alg&quot;: &quot;HS256&quot;,//签名或摘要算法</span><br><span class="line">    &quot;typ&quot;: &quot;JWT&quot;//token类型</span><br><span class="line">&#125;</span><br><span class="line">Playload//荷载信息</span><br><span class="line">&#123;</span><br><span class="line">    &quot;iss&quot;: &quot;token-server&quot;,//签发者</span><br><span class="line">    &quot;exp &quot;: &quot;Mon Nov 13 15:28:41 CST 2017&quot;,//过期时间</span><br><span class="line">    &quot;sub &quot;: &quot;wangjie&quot;,//用户名</span><br><span class="line">    &quot;aud&quot;: &quot;web-server-1&quot;//接收方,</span><br><span class="line">    &quot;nbf&quot;: &quot;Mon Nov 13 15:40:12 CST 2017&quot;,//这个时间之前token不可用</span><br><span class="line">    &quot;jat&quot;: &quot;Mon Nov 13 15:20:41 CST 2017&quot;,//签发时间</span><br><span class="line">    &quot;jti&quot;: &quot;0023&quot;,//令牌id标识</span><br><span class="line">    &quot;claim&quot;: &#123;“auth”:”ROLE_ADMIN”&#125;//访问主张</span><br><span class="line">&#125;</span><br><span class="line">Signature//签名信息</span><br><span class="line">签名或摘要算法（</span><br><span class="line">    base64urlencode（Header），</span><br><span class="line">    Base64urlencode（Playload），</span><br><span class="line">    secret-key</span><br><span class="line">）</span><br></pre></td></tr></table></figure>
<p>按照JWT规范，对这个令牌定义进行如下操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">base64urlencode（Header）</span><br><span class="line">+&quot;.&quot;+</span><br><span class="line">base64urlencode（Playload）</span><br><span class="line">+&quot;.&quot;+</span><br><span class="line">signature（</span><br><span class="line">    base64urlencode（Header）</span><br><span class="line">    +&quot;.&quot;+</span><br><span class="line">    base64urlencode（Playload）</span><br><span class="line">    ,secret-key</span><br><span class="line">）</span><br></pre></td></tr></table></figure>
<p>形成一个完整的JWT:<br><code>eyJhbGciOiJIUzUxMiIsInppcCI6IkRFRiJ9.eNqqVspMLFGyMjQ1NDA1tTA0NNRRKi5NUrJSKk_MS8_KTFXSUUqtKEAoMDKsBQAAAP__.dGLe7BVECKzQ_utZJqk4hbcBZthNhohuEjjue98vmpQSGn_9cCYHq7lPIfwKubW8M553F8Uhk933EJwgI5vbLQ</code></p>
<p>需要注意的是：</p>
<p>1：荷载信息(Playload)中的属性可以根据情况进行设置，不要求必须全部填写。</p>
<p>2：由token的生成方式发现，Header和Playload仅仅是base64编码，通过base64解码之后可见，基本相当于是明文传输，所以应避免敏感信息放入Playload。</p>
<p><strong>2、令牌特点</strong></p>
<p>紧凑性：体积较小、意味着传输速度快，可以作为POST参数或放置在HTTP头。</p>
<p>自包含性：有效的负载包含用户鉴权所需所有信息，避免多次查询数据库。</p>
<p>安全性：支持对称和非对称方式(HMAC、RSA)进行消息摘要签名。</p>
<p>标准化：开放标准，多语言支持，跨平台。</p>
<p><strong>3、适用场景</strong></p>
<p>1：无状态、分布式鉴权，比如rest api系统、微服务系统。</p>
<p>2：方便解决跨域授权的问题，比如SSO单点登陆。</p>
<p>3：JWT只是消息协议，不牵涉到会话管理和存储机制，所以单体WEB应用还是推荐session-cookie机制。</p>
<h3 id="典型微服务鉴权架构"><a href="#典型微服务鉴权架构" class="headerlink" title="典型微服务鉴权架构"></a>典型微服务鉴权架构</h3><p>客户端（移动端或者pc端）根据口令或者APP KEY到认证服务鉴权并申请签发令牌，如果需要操作服务A，必须先拿着令牌到服务A进行权限问询。如果需要操作服务B，同样先拿着令牌到服务B进行权限问询，一个令牌可以一次，也可以多次使用连续穿梭多个服务系统，直至令牌过期失效或被销毁。</p>
<p>JWT令牌使用了数字签名可以有效的防止数据篡改和窃取，同样申请令牌时的数据也需要有这样的安全保障，可以使用HMAC(哈希运算消息认证码)进行签名（摘要）和验签（参考：<a href="https://www.jianshu.com/p/b0a577708a7b" target="_blank" rel="noopener">基于hmac的rest api鉴权处理</a>）。</p>
<p>shiro是java业界普遍采用的安全框架，简单、够用、扩展性强。我们可以在shiro中添加对HMAC和JWT这两种鉴权方式的支持。</p>
<h2 id="令牌签发服务"><a href="#令牌签发服务" class="headerlink" title="令牌签发服务"></a>令牌签发服务</h2><p>签发服务的核心功能是验证客户端是否合法，如果合法则授予其包含特定访问主张的JWT。</p>
<p>shiro Token定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * HMAC令牌</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacToken implements AuthenticationToken&#123;</span><br><span class="line">    private static final long serialVersionUID = -7838912794581842158L;</span><br><span class="line">    </span><br><span class="line">    private String clientKey;// 客户标识（可以是用户名、app id等等）</span><br><span class="line">    private String digest;// 消息摘要</span><br><span class="line">    private String timeStamp;// 时间戳</span><br><span class="line">    private Map&lt;String, String[]&gt; parameters;// 访问参数</span><br><span class="line">    private String host;// 客户端IP</span><br><span class="line">    </span><br><span class="line">    public HmacToken(String clientKey,String timeStamp,String digest</span><br><span class="line">                                ,String host,Map&lt;String, String[]&gt; parameters)&#123;</span><br><span class="line">        this.clientKey = clientKey;</span><br><span class="line">        this.timeStamp = timeStamp;</span><br><span class="line">        this.digest = digest;</span><br><span class="line">        this.host = host;</span><br><span class="line">        this.parameters = parameters;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    @Override</span><br><span class="line">    public Object getPrincipal() &#123;</span><br><span class="line">        return this.clientKey;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Object getCredentials() &#123;</span><br><span class="line">        return Boolean.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 省略getters and setters ... ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>shiro Realm即验证逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于HMAC（ 散列消息认证码）的控制域</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacRealm extends AuthorizingRealm&#123;</span><br><span class="line">    </span><br><span class="line">    private final AccountProvider accountProvider;//账号服务(持久化服务)</span><br><span class="line">    private final CryptogramService cryptogramService;//密码服务</span><br><span class="line"></span><br><span class="line">    public HmacRealm(AccountProvider accountProvider,CryptogramService cryptogramService)&#123;</span><br><span class="line">        this.accountProvider = accountProvider;</span><br><span class="line">        this.cryptogramService = cryptogramService;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public Class&lt;?&gt; getAuthenticationTokenClass() &#123;</span><br><span class="line">        return HmacToken.class;//此Realm只支持HmacToken</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     *  认证</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) </span><br><span class="line">                                                          throws AuthenticationException &#123;</span><br><span class="line">        HmacToken hmacToken = (HmacToken)token;</span><br><span class="line">        List&lt;String&gt; keys = Lists.newArrayList();</span><br><span class="line">        for (String key:hmacToken.getParameters().keySet())&#123;</span><br><span class="line">            if (!&quot;digest&quot;.equals(key))</span><br><span class="line">                keys.add(key);</span><br><span class="line">        &#125;</span><br><span class="line">        Collections.sort(keys);//对请求参数进行排序参数-&gt;自然顺序</span><br><span class="line">        StringBuffer baseString = new StringBuffer();</span><br><span class="line">        for (String key : keys) &#123;</span><br><span class="line">            baseString.append(hmacToken.getParameters().get(key)[0]);</span><br><span class="line">        &#125;</span><br><span class="line">        //认证端生成摘要</span><br><span class="line">        String serverDigest = cryptogramService.hmacDigest(baseString.toString());</span><br><span class="line">        //客户端请求的摘要和服务端生成的摘要不同</span><br><span class="line">        if(!serverDigest.equals(hmacToken.getDigest()))&#123;</span><br><span class="line">            throw new AuthenticationException(&quot;数字摘要验证失败！！！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Long visitTimeStamp = Long.valueOf(hmacToken.getTimeStamp());</span><br><span class="line">        Long nowTimeStamp = System.currentTimeMillis();</span><br><span class="line">        Long jge = nowTimeStamp - visitTimeStamp;</span><br><span class="line">        if (jge &gt; 600000) &#123;// 十分钟之前的时间戳，这是有效期可以双方约定由参数传过来</span><br><span class="line">            throw new AuthenticationException(&quot;数字摘要失效！！！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        // 此处可以添加查询数据库检查账号是否存在、是否被锁定、是否被禁用等等逻辑</span><br><span class="line">        return new SimpleAuthenticationInfo(hmacToken.getClientKey(),Boolean.TRUE,getName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /** </span><br><span class="line">     * 授权 </span><br><span class="line">     */  </span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        String clientKey = (String)principals.getPrimaryPrincipal();</span><br><span class="line">        SimpleAuthorizationInfo info =  new SimpleAuthorizationInfo();</span><br><span class="line">        // 根据客户标识（可以是用户名、app id等等） 查询并设置角色</span><br><span class="line">        Set&lt;String&gt; roles = accountProvider.loadRoles(clientKey);</span><br><span class="line">        info.setRoles(roles);</span><br><span class="line">      // 根据客户标识（可以是用户名、app id等等） 查询并设置权限</span><br><span class="line">        Set&lt;String&gt; permissions = accountProvider.loadPermissions(clientKey);</span><br><span class="line">        info.setStringPermissions(permissions);</span><br><span class="line">        return info;  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HMAC认证过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于HMAC（ 散列消息认证码）的无状态认证过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class HmacFilter extends AccessControlFilter&#123;</span><br><span class="line">    </span><br><span class="line">    private static final Logger log = LoggerFactory.getLogger(AccessControlFilter.class);</span><br><span class="line">    </span><br><span class="line">    public static final String DEFAULT_CLIENTKEY_PARAM = &quot;clientKey&quot;;</span><br><span class="line">    public static final String DEFAULT_TIMESTAMP_PARAM = &quot;timeStamp&quot;;</span><br><span class="line">    public static final String DEFAUL_DIGEST_PARAM = &quot;digest&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 是否放行</span><br><span class="line">     */</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, </span><br><span class="line">                                                        Object mappedValue) throws Exception &#123;</span><br><span class="line">        if (null != getSubject(request, response) </span><br><span class="line">                &amp;&amp; getSubject(request, response).isAuthenticated()) &#123;</span><br><span class="line">            return true;//已经认证过直接放行</span><br><span class="line">        &#125;</span><br><span class="line">        return false;//转到拒绝访问处理逻辑</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 拒绝处理</span><br><span class="line">     */</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response)  </span><br><span class="line">                                                                          throws Exception &#123;</span><br><span class="line">        if(isHmacSubmission(request))&#123;//如果是Hmac鉴权的请求</span><br><span class="line">            //创建令牌</span><br><span class="line">            AuthenticationToken token = createToken(request, response);</span><br><span class="line">            try &#123;</span><br><span class="line">                Subject subject = getSubject(request, response);</span><br><span class="line">                subject.login(token);//认证</span><br><span class="line">                return true;//认证成功，过滤器链继续</span><br><span class="line">            &#125; catch (AuthenticationException e) &#123;//认证失败，发送401状态并附带异常信息</span><br><span class="line">                log.error(e.getMessage(),e);</span><br><span class="line">                WebUtils.toHttp(response).sendError(HttpServletResponse.SC_UNAUTHORIZED,e.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;//打住，访问到此为止</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AuthenticationToken createToken(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        String clientKey = request.getParameter(DEFAULT_CLIENTKEY_PARAM);</span><br><span class="line">        String timeStamp= request.getParameter(DEFAULT_TIMESTAMP_PARAM);</span><br><span class="line">        String digest= request.getParameter(DEFAUL_DIGEST_PARAM);</span><br><span class="line">        Map&lt;String, String[]&gt; parameters = request.getParameterMap();</span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        return new HmacToken(clientKey, timeStamp, digest, host,parameters);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected boolean isHmacSubmission(ServletRequest request) &#123;</span><br><span class="line">        String clientKey = request.getParameter(DEFAULT_CLIENTKEY_PARAM);</span><br><span class="line">        String timeStamp= request.getParameter(DEFAULT_TIMESTAMP_PARAM);</span><br><span class="line">        String digest= request.getParameter(DEFAUL_DIGEST_PARAM);</span><br><span class="line">        return (request instanceof HttpServletRequest)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(clientKey)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(timeStamp)</span><br><span class="line">                            &amp;&amp; StringUtils.isNotBlank(digest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>HMAC鉴权最基础的工作就此完成，需要注意的是鉴权是无状态的不需要创建SESSION,所以需要对shiro的SubjectFactory做一下改造，并设置到SecurityManager ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 扩展自DefaultWebSubjectFactory,对于无状态的TOKEN 类型不创建session</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604)</span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class AgileSubjectFactory extends DefaultWebSubjectFactory &#123; </span><br><span class="line"></span><br><span class="line">    public Subject createSubject(SubjectContext context) &#123; </span><br><span class="line">        AuthenticationToken token = context.getAuthenticationToken();</span><br><span class="line">        if((token instanceof HmacToken))&#123;</span><br><span class="line">            // 当token为HmacToken时， 不创建 session </span><br><span class="line">            context.setSessionCreationEnabled(false);</span><br><span class="line">        &#125;</span><br><span class="line">        return super.createSubject(context); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT签发逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/auth&quot;)</span><br><span class="line">public class AuthenticateAction &#123;</span><br><span class="line">    private final String SECRET_KEY = &quot;*(-=4eklfasdfarerf41585fdasf&quot;;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(value=&quot;/apply-token&quot;,method=RequestMethod.POST)</span><br><span class="line">    public Map&lt;String,Object&gt; applyToken(@RequestParam(name=&quot;clientKey&quot;) String clientKey) &#123;</span><br><span class="line">        // 签发一个Json Web Token</span><br><span class="line">        // 令牌ID=uuid，用户=clientKey，签发者=clientKey</span><br><span class="line">        // token有效期=1分钟，用户角色=null,用户权限=create,read,update,delete</span><br><span class="line">        String jwt = issueJwt(UUID.randomUUID().toString(), clientKey, </span><br><span class="line">                                    &quot;token-server&quot;,60000l, null, &quot;create,read,update,delete&quot;);</span><br><span class="line">        Map&lt;String,Object&gt; respond = Maps.newHashMap();</span><br><span class="line">        respond.put(&quot;jwt&quot;, jwt);</span><br><span class="line">        return respond;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    /**</span><br><span class="line">     * @param id 令牌ID</span><br><span class="line">     * @param subject 用户ID</span><br><span class="line">     * @param issuer 签发人</span><br><span class="line">     * @param period 有效时间(毫秒)</span><br><span class="line">     * @param roles 访问主张-角色</span><br><span class="line">     * @param permissions 访问主张-权限</span><br><span class="line">     * @param algorithm 加密算法</span><br><span class="line">     * @return json web token </span><br><span class="line">     */</span><br><span class="line">    private String issueJwt(String id,String subject,String issuer,Long period,String roles</span><br><span class="line">                                            ,String permissions,SignatureAlgorithm algorithm) &#123;</span><br><span class="line">        long currentTimeMillis = System.currentTimeMillis();// 当前时间戳</span><br><span class="line">        byte[] secretKeyBytes = DatatypeConverter.parseBase64Binary(SECRET_KEY);// 秘钥</span><br><span class="line">        JwtBuilder jwt  =  Jwts.builder();</span><br><span class="line">        if(Strings.isNotBlank(id)) jwt.setId(id);</span><br><span class="line">        jwt.setSubject(subject);// 用户名主题</span><br><span class="line">        if(Strings.isNotBlank(issuer)) jwt.setIssuer(issuer);//签发者</span><br><span class="line">        if(Strings.isNotBlank(issuer)) jwt.setIssuer(issuer);//签发者  </span><br><span class="line">        jwt.setIssuedAt(new Date(currentTimeMillis));//签发时间</span><br><span class="line">        if(null != period)&#123;</span><br><span class="line">            Date expiration = new Date(currentTimeMillis+period);</span><br><span class="line">            jwt.setExpiration(expiration);//有效时间</span><br><span class="line">        &#125;</span><br><span class="line">        if(Strings.isNotBlank(roles)) jwt.claim(&quot;roles&quot;, roles);//角色</span><br><span class="line">        if(Strings.isNotBlank(permissions)) jwt.claim(&quot;perms&quot;, permissions);//权限</span><br><span class="line">        jwt.compressWith(CompressionCodecs.DEFLATE);//压缩，可选GZIP</span><br><span class="line">        jwt.signWith(algorithm, secretKeyBytes);//加密设置</span><br><span class="line">        return jwt.compact();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加过滤器：filterChainManager.addFilter( “hmac”, new HmacFilter()）;<br>配置过滤规则：filterChainManager.addToChain(“/auth/**”, “hmac”);<br>如果有需要可以在规则中添加其他过滤器。<br>JWT申请测试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">public String applyToken()&#123;</span><br><span class="line">    Long current = System.currentTimeMillis() ;</span><br><span class="line">    String url = &quot;http://localhost:8080/tokenServer/auth/apply-token&quot;;</span><br><span class="line">    MultiValueMap&lt;String, Object&gt; dataMap = new LinkedMultiValueMap&lt;String, Object&gt;();  </span><br><span class="line">    String clientKey = &quot;administrator&quot;;// 客户端标识（用户名）</span><br><span class="line">    String mix = String.valueOf(new Random().nextFloat());// 随机数，进行混淆</span><br><span class="line">    String timeStamp = current.toString();// 时间戳</span><br><span class="line">    dataMap.add(&quot;clientKey&quot;, clientKey);</span><br><span class="line">    dataMap.add(&quot;mix&quot;, mix);</span><br><span class="line">    dataMap.add(&quot;timeStamp&quot;, timeStamp);</span><br><span class="line">    String baseString = clientKey+mix+timeStamp;</span><br><span class="line">    String digest =  hmacDigest(baseString);// 生成HMAC摘要</span><br><span class="line">    dataMap.add(&quot;digest&quot;, digest);</span><br><span class="line">    Map result = rt.postForObject(url, dataMap, Map.class);</span><br><span class="line">    return (String)result.get(&quot;jwt&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>返回JWT：</p>
<blockquote>
<p>eyJhbGciOiJIUzUxMiIsInppcCI6IkRFRiJ9.eNo8y80KwjAQBOB32XMCTfNj7NvsNluI2jYkWxHEdzf14GUYPmbecJMMEwzXGAjnUdvBR-2cdzpSRE2jiUtwSLQEUNAO6mNMa95yk4qy1665ta6y33nTjeuTf4gCk_HGWBvtxSjgV_mDsx0K1_U8zpVRWPVM6ijp7IkfLAyfLwAAAP__.GK7EJibs7n50uGksvvLK6Y39Ur6ZYXoXI9LOlFwEpIijHGAZjIyDhiYD-1nv1YbPJ46BI-gDTntV3KC0d8NSrA</p>
</blockquote>
<h2 id="令牌验签"><a href="#令牌验签" class="headerlink" title="令牌验签"></a>令牌验签</h2><p>有了JWT签发服务，要使用JWT就需要业务系统有JWT验鉴功能，同样在shiro中集成。<br>由于JWT是自包含的，令牌中已经声明了访问主张(比如角色、权限等)，验签功能只需要验证令牌合法就行了，不需要访问数据库。</p>
<p>shiro Token定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * JWT令牌</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtToken implements AuthenticationToken&#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -790191688300000066L;</span><br><span class="line">    </span><br><span class="line">    private String jwt;// json web token</span><br><span class="line">    private String host;// 客户端IP</span><br><span class="line">    </span><br><span class="line">    public JwtToken(String jwt,String host)&#123;</span><br><span class="line">        this.jwt = jwt;</span><br><span class="line">        this.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getPrincipal() &#123;</span><br><span class="line">        return this.jwt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object getCredentials() &#123;</span><br><span class="line">        return Boolean.TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 忽略getters and setters</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JWT Realm即认证逻辑定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT（ JSON WEB TOKEN）的认证域</span><br><span class="line"> * </span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604)</span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtRealm extends AuthorizingRealm &#123;</span><br><span class="line"></span><br><span class="line">    public Class&lt;?&gt; getAuthenticationTokenClass() &#123;</span><br><span class="line">        return JwtToken.class;//此Realm只支持JwtToken</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 认证</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken token) </span><br><span class="line">                                                        throws AuthenticationException &#123;</span><br><span class="line">        JwtToken jwtToken = (JwtToken) token;</span><br><span class="line">        String jwt = (String) jwtToken.getPrincipal();</span><br><span class="line">        JwtPlayload jwtPlayload;</span><br><span class="line">        try &#123;</span><br><span class="line">            Claims claims = Jwts.parser()</span><br><span class="line">                    .setSigningKey(DatatypeConverter.parseBase64Binary(SECRETKEY))</span><br><span class="line">                    .parseClaimsJws(jwt)</span><br><span class="line">                    .getBody();</span><br><span class="line">            jwtPlayload = new JwtPlayload();</span><br><span class="line">            jwtPlayload.setId(claims.getId());</span><br><span class="line">            jwtPlayload.setUserId(claims.getSubject());// 用户名</span><br><span class="line">            jwtPlayload.setIssuer(claims.getIssuer());// 签发者</span><br><span class="line">            jwtPlayload.setIssuedAt(claims.getIssuedAt());// 签发时间</span><br><span class="line">            jwtPlayload.setAudience(claims.getAudience());// 接收方</span><br><span class="line">            jwtPlayload.setRoles(claims.get(&quot;roles&quot;, String.class));// 访问主张-角色</span><br><span class="line">            jwtPlayload.setPerms(claims.get(&quot;perms&quot;, String.class));// 访问主张-权限</span><br><span class="line">        &#125; catch (ExpiredJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌过期:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (UnsupportedJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌无效:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (MalformedJwtException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌格式错误:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (SignatureException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌签名无效:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (IllegalArgumentException e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌参数异常:&quot; + e.getMessage());</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            throw new AuthenticationException(&quot;JWT 令牌错误:&quot; + e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        // 如果要使token只能使用一次，此处可以过滤并缓存jwtPlayload.getId()</span><br><span class="line">        // 可以做签发方验证</span><br><span class="line">        // 可以做接收方验证</span><br><span class="line">        return new SimpleAuthenticationInfo(jwtPlayload, Boolean.TRUE, getName());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 授权,JWT已包含访问主张只需要解析其中的主张定义就行了</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) &#123;</span><br><span class="line">        JwtPlayload jwtPlayload = (JwtPlayload) principals.getPrimaryPrincipal();</span><br><span class="line">        SimpleAuthorizationInfo info = new SimpleAuthorizationInfo();</span><br><span class="line">        // 解析角色并设置</span><br><span class="line">        Set&lt;String&gt; roles = Sets.newHashSet(StringUtils.split(jwtPlayload.getRoles(), &quot;,&quot;));</span><br><span class="line">        info.setRoles(roles);</span><br><span class="line">        // 解析权限并设置</span><br><span class="line">        Set&lt;String&gt; permissions = Sets.newHashSet(StringUtils.split(jwtPlayload.getPerms(), &quot;,&quot;));</span><br><span class="line">        info.setStringPermissions(permissions);</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理逻辑中抛出的异常信息很详细，其实这样并不安全只是对调试友好，线上环境不用把异常信息给那么细。</p>
<p>JWT鉴权过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT标准的无状态认证过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> * </span><br><span class="line"> */ </span><br><span class="line">public class JwtFilter extends AccessControlFilter &#123;</span><br><span class="line">    </span><br><span class="line">    private static final Logger log = LoggerFactory.getLogger(AccessControlFilter.class);</span><br><span class="line">    </span><br><span class="line">    public static final String DEFAULT_JWT_PARAM = &quot;jwt&quot;;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, Object mappedValue) throws Exception &#123;</span><br><span class="line">        if (null != getSubject(request, response) </span><br><span class="line">                &amp;&amp; getSubject(request, response).isAuthenticated()) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected boolean onAccessDenied(ServletRequest request, ServletResponse response) throws Exception &#123;</span><br><span class="line">        if(isJwtSubmission(request))&#123;</span><br><span class="line">            AuthenticationToken token = createToken(request, response);</span><br><span class="line">            try &#123;</span><br><span class="line">                Subject subject = getSubject(request, response);</span><br><span class="line">                subject.login(token);</span><br><span class="line">                return true;</span><br><span class="line">            &#125; catch (AuthenticationException e) &#123;</span><br><span class="line">                log.error(e.getMessage(),e);</span><br><span class="line">                WebUtils.toHttp(response).sendError(HttpServletResponse.SC_UNAUTHORIZED,e.getMessage());</span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected AuthenticationToken createToken(ServletRequest request, ServletResponse response) &#123;</span><br><span class="line">        String jwt = request.getParameter(DEFAULT_JWT_PARAM);</span><br><span class="line">        String host = request.getRemoteHost();</span><br><span class="line">        log.info(&quot;authenticate jwt token:&quot;+jwt);</span><br><span class="line">        System.out.println(&quot;jwt:&quot;+jwt);</span><br><span class="line">        return new JwtToken(jwt, host);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    protected boolean isJwtSubmission(ServletRequest request) &#123;</span><br><span class="line">        String jwt = request.getParameter(DEFAULT_JWT_PARAM);</span><br><span class="line">        return (request instanceof HttpServletRequest)</span><br><span class="line">                                &amp;&amp; StringUtils.isNotBlank(jwt);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>资源访问权限过滤器定义：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 基于JWT（ JSON WEB TOKEN）的无状态资源过滤器</span><br><span class="line"> * @author wangjie (http://www.jianshu.com/u/ffa3cba4c604) </span><br><span class="line"> * @date 2016年6月24日 下午2:55:15</span><br><span class="line"> */</span><br><span class="line">public class JwtPermFilter extends HmacFilter&#123;</span><br><span class="line">    @Override</span><br><span class="line">    protected boolean isAccessAllowed(ServletRequest request, ServletResponse response, </span><br><span class="line">                                                    Object mappedValue) throws Exception &#123;</span><br><span class="line">        Subject subject = getSubject(request, response);</span><br><span class="line">        String[] perms = (String[]) mappedValue;</span><br><span class="line">        boolean isPermitted = true;</span><br><span class="line">        if (perms != null &amp;&amp; perms.length &gt; 0) &#123;</span><br><span class="line">            if (perms.length == 1) &#123;</span><br><span class="line">                if (!subject.isPermitted(perms[0])) &#123;</span><br><span class="line">                    isPermitted = false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                if (!subject.isPermittedAll(perms)) &#123;</span><br><span class="line">                    isPermitted = false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return isPermitted;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>添加过滤器：filterChainManager.addFilter( “jwt”, new JwtFilter()）;<br>filterChainManager.addFilter( “jwtPerms”, new JwtPermFilter()）;<br>配置过滤规则：filterChainManager.addToChain(“/api/<strong>“, “jwt”);filterChainManager.addToChain(“/api/delete/</strong>“, “jwtPerms[“api:delete”]”);<br>如果有需要可以在规则中添加其他过滤器。<br>同令牌申请服务一样，需要设置shiro不创建SESSION。</p>
<p>转自：<a href="https://wangjie2016.iteye.com/blog/2406870" target="_blank" rel="noopener">shiro jwt 构建无状态分布式鉴权体系</a></p>
<h2 id="项目推荐：功能强大的jsets-shiro-spring-boot-starter"><a href="#项目推荐：功能强大的jsets-shiro-spring-boot-starter" class="headerlink" title="项目推荐：功能强大的jsets-shiro-spring-boot-starter"></a>项目推荐：功能强大的jsets-shiro-spring-boot-starter</h2><p>github地址：<a href="https://github.com/wj596/jsets-shiro-spring-boot-starter" target="_blank" rel="noopener">jsets-shiro-spring-boot-starter</a></p>
<p><strong>项目说明：</strong></p>
<p>springboot中使用shiro大都是通过shiro-spring.jar进行的整合的,虽然不是太复杂，但是也无法做到spring-boot-starter风格的开箱即用。</p>
<p>项目中经常用到的功能比如：验证码、密码错误次数限制、账号唯一用户登陆、动态URL过滤规则、无状态鉴权等等，shiro还没有直接提供支持。</p>
<p>jsets-shiro-spring-boot-starter对这些常用的功能进行了封装和自动导入，少量的配置就可以应用在项目中。</p>
<p><strong>推荐理由：</strong></p>
<ul>
<li><p>springboot-start开箱即用</p>
</li>
<li><p>提供动态URL过滤规则的功能，让你可以从数据库中读取权限信息，修改的权限之后还可动态刷新url过滤规则</p>
</li>
<li>提供无状态鉴权功能</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Shiro/" rel="tag"># Shiro</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/07/Springboot整合Shiro/" rel="next" title="Springboot整合Shiro">
                <i class="fa fa-chevron-left"></i> Springboot整合Shiro
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="SOHUCS"></div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/touxiang.png"
                alt="黄国航" />
            
              <p class="site-author-name" itemprop="name">黄国航</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Hghhhh" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:huangguohang123@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT"><span class="nav-text">JWT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#典型微服务鉴权架构"><span class="nav-text">典型微服务鉴权架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#令牌签发服务"><span class="nav-text">令牌签发服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#令牌验签"><span class="nav-text">令牌验签</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#项目推荐：功能强大的jsets-shiro-spring-boot-starter"><span class="nav-text">项目推荐：功能强大的jsets-shiro-spring-boot-starter</span></a></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黄国航</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v="></script>

  <script type="text/javascript" src="/js/src/motion.js?v="></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v="></script>
<script type="text/javascript" src="/js/src/post-details.js?v="></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v="></script>



  


  




	





  





  




  
    <script type="text/javascript">
    (function(){
      var appid = 'cytyqQfqe';
      var conf = '6a41e203093499026ca336cb276dfdc4';
      var width = window.innerWidth || document.documentElement.clientWidth;
      if (width < 960) {
      window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){
        window.changyan.api.config({appid:appid,conf:conf})});
      }
    })();
    </script>
    <script type="text/javascript" src="https://assets.changyan.sohu.com/upload/plugins/plugins.count.js"></script>
  









  





  

  

  

  
  

  

  

  

</body>
</html>
